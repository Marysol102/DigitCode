<!DOCTYPE html>
<html lang="es">
<head>
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta charset="UTF-8">
    <title>Hide Code - Master Edition Online</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>

    <style>
        :root { 
            --bg-sheet: #ffffff; 
            --st-on: #222; 
            --st-off: #f0f0f0; 
            --accent-blue: #00d2ff;
            --accent-solo: #ff9800;
            --accent-private: #9c27b0;
            --seg-h-thick: 12px;
            --seg-v-height: 45px;
            --digit-h: 114px;
        }
        
        body { font-family: 'Segoe UI', sans-serif; background-color: #90a4ae; display: flex; flex-direction: column; align-items: center; padding: 20px; margin: 0; }
        .mode-selector { background: #263238; color: white; padding: 10px 20px; border-radius: 8px; margin-bottom: 15px; font-size: 14px; }
        .digit-reference { display: flex; gap: 15px; background: rgba(0,0,0,0.1); padding: 15px 25px; border-radius: 12px; margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.3); }
        .ref-item { display: flex; flex-direction: column; align-items: center; opacity: 0.7; }
        .ref-num { font-weight: bold; color: #000; margin-bottom: 5px; font-size: 14px; }
        .mini-seg-grid { position: relative; width: 20px; height: 35px; }
        .ms { position: absolute; background: #bbb; border-radius: 1px; }
        .m-h { height: 3px; left: 4px; right: 4px; }
        .m-v { width: 3px; height: 12px; }
        .active-ref { background: #000 !important; }
        
        .wrapper { display: flex; gap: 20px; max-width: 1350px; width: 100%; }
        .wrapper.vertical { flex-direction: column; align-items: center; }
        
        .sheet { background: var(--bg-sheet); padding: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.4); border-radius: 4px; flex-grow: 1; border: 1px solid #666; transition: background-color 0.8s ease; }
        .header-title { text-align: center; font-weight: 900; font-size: 30px; margin-bottom: 20px; border-bottom: 4px solid #000; padding-bottom: 10px; }
        
        .game-grid { display: grid; grid-template-columns: 80px 1fr 40px 1fr 40px 1fr; align-items: start; gap: 5px; }
        
        .labels-side { display: flex; flex-direction: column; border-right: 3px solid #000; padding-right: 10px; margin-top: 37px; } 
        .label-row { display: flex; align-items: center; justify-content: flex-end; gap: 5px; height: var(--seg-h-thick); margin-bottom: 13px; font-weight: bold; font-size: 14px; }
        .label-row:last-child { margin-bottom: 0; }
        .label-row input { width: 22px; height: 16px; text-align: center; border: 1px solid #ccc; font-size: 11px; }

        .digit-block { display: flex; flex-direction: column; align-items: center; padding: 0 5px; }
        .digit-block.bottom-row { margin-top: 37px; } 

        .abc-header { display: flex; gap: 10px; margin-bottom: 10px; height: 25px; }
        .abc-item { display: flex; flex-direction: column; align-items: center; font-size: 11px; font-weight: bold; }
        .abc-item input { width: 18px; height: 14px; text-align: center; border: 1px solid #ccc; }

        .digit-visual { position: relative; width: 66px; height: var(--digit-h); background: #fff; border: 1px solid #eee; }
        .seg { position: absolute; background: var(--st-off); border: 1px solid #ddd; cursor: pointer; }
        /* Estilo para apagado autom√°tico (Q4) */
        .st-off-auto { background: repeating-linear-gradient(45deg, #fff, #fff 2px, #ff5252 3px, #ff5252 4px) !important; border-color: #ffcdd2; }
        
        .seg-h { height: var(--seg-h-thick); left: 12px; right: 12px; }
        .seg-v { width: 12px; height: 39px; } 
        .s-a { top: 0; } .s-g { top: 51px; } .s-d { bottom: 0; }
        .s-f { left: 0; top: 6px; } .s-b { right: 0; top: 6px; }
        .s-e { left: 0; top: 57px; } .s-c { right: 0; top: 57px; }
        .st-1 { background: var(--st-on) !important; border-color: #000; }
        
        .comp { width: 32px; height: 32px; border: 2px solid #000; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; background: #fff; cursor: pointer; align-self: center; margin-top: 40px;}
        .rotate-90 { transform: rotate(90deg); display: inline-block; }
        .v-comps { grid-column: 2 / 7; display: flex; justify-content: space-around; padding: 15px 0; }
        
        .scratch-pad { display: grid; grid-template-columns: repeat(5, 1fr); gap: 2px; margin-top: 10px; }
        .num-pick { font-size: 10px; width: 18px; height: 18px; border: 1px solid #ddd; cursor: pointer; text-align: center; line-height: 18px; background: #fff; }
        .num-pick.scratched { text-decoration: line-through; color: #ccc; background: #fafafa; }
        
        /* Estilos nuevos para Par/Impar (Q2) */
        .parity-container { display: flex; gap: 4px; margin-top: 5px; }
        .p-indicator { font-size: 10px; padding: 2px 4px; border: 1px solid #ccc; border-radius: 3px; cursor: pointer; color: #999; }
        .p-indicator.active { background: #000; color: #fff; border-color: #000; font-weight: bold; }

        /* Resaltado de entrada autom√°tica */
        .auto-fill { color: #D32F2F !important; font-weight: 900 !important; border-color: #D32F2F !important; animation: highlight 1.5s ease; }
        @keyframes highlight { 0% { background: #ffcdd2; } 100% { background: transparent; } }

        .ai-panel { background: #263238; color: #fff; width: 340px; padding: 20px; border-radius: 12px; height: fit-content; position: sticky; top: 20px; }
        .ai-panel h3 { color: var(--accent-blue); margin-top: 0; text-align: center; font-size: 18px; text-transform: uppercase; }
        .q-box { background: #37474f; padding: 12px; margin-bottom: 10px; border-radius: 6px; border-left: 4px solid var(--accent-blue); position: relative; }
        .q-box label { font-size: 12px; font-weight: bold; display: block; margin-bottom: 8px; color: #cfd8dc; }
        .q-controls { display: flex; gap: 5px; }
        .btn-private { background: var(--accent-private) !important; color: white !important; width: 40px !important; flex-shrink: 0; font-size: 18px !important; display: none; }
        
        select, button { width: 100%; padding: 8px; border-radius: 4px; border: none; font-size: 13px; }
        button { background: var(--accent-blue); color: #000; font-weight: bold; cursor: pointer; margin-top: 5px; }
        #log { background: #000; color: #00e676; height: 250px; overflow-y: auto; padding: 10px; font-family: monospace; font-size: 12px; border: 2px solid #455a64; margin-top: 10px; }
        .setup-box { border: 2px dashed #546e7a; padding: 12px; margin-bottom: 15px; text-align: center; border-radius: 8px; }
        .setup-inputs { display: flex; gap: 5px; justify-content: center; margin-top: 8px; }
        .setup-inputs input { width: 32px; height: 32px; text-align: center; font-weight: bold; font-size: 16px; border-radius: 4px; border: 1px solid #999; }
        
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .login-box { background: #37474f; padding: 30px; border-radius: 12px; color: white; text-align: center; border: 2px solid var(--accent-blue); width: 300px; }
        
        .solo-btn { background: var(--accent-solo); color: #000; font-weight: bold; margin-top: 10px; cursor: pointer; }
        .btn-disabled { background: #546e7a !important; color: #cfd8dc !important; cursor: not-allowed !important; opacity: 0.7; }
        
        .rank-table { width: 100%; border-collapse: collapse; margin-bottom: 15px; font-size: 12px; margin-top: 10px; }
        .rank-table th, .rank-table td { border: 1px solid #546e7a; padding: 4px; text-align: left; }
        .rank-table th { background: #37474f; }
        
        .bar-container { height: 14px; background: #333; width: 100%; margin-top: 2px; border-radius: 2px; position: relative; }
        .bar-fill { height: 100%; background: var(--accent-solo); width: 0%; border-radius: 2px; transition: width 0.5s; display: flex; align-items: center; justify-content: center; font-size: 9px; color: #000; font-weight: bold; overflow: hidden; white-space: nowrap; }
        
        .question-counter { font-size: 20px; font-weight: bold; text-align: center; margin-bottom: 10px; color: var(--accent-solo); }
        
        @keyframes pulse-turn { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }
        .turn-tag { background: #ff5252; color: white; padding: 10px; border-radius: 4px; margin-bottom: 10px; font-weight: bold; text-align: center; font-size: 14px; }
        .turn-tag.active { background: #4caf50; animation: pulse-turn 1.5s infinite; border: 2px solid #fff; }
        #player-list-box { background: rgba(0,0,0,0.2); border-radius: 4px; padding: 10px; margin-bottom: 20px; font-size: 13px; }
        .pl-row { padding: 4px 0; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between; }

        /* MODAL DE VICTORIA */
        #win-modal { display:none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:2000; align-items:center; justify-content:center; }
        .win-box { background:#263238; border: 3px solid #4caf50; padding:30px; border-radius:15px; color:white; text-align:center; max-width:400px; width:90%; box-shadow: 0 0 30px rgba(76, 175, 80, 0.5); }
        .win-box h2 { color:#4caf50; margin-top:0; }
        .win-box p { font-size: 16px; line-height: 1.5; margin: 20px 0; }
        .win-btns { display:flex; gap:10px; }
        .win-btns button { flex:1; padding:12px; }

        .hint-step { background: rgba(255,152,0,0.1); border: 1px solid var(--accent-solo); border-radius: 4px; padding: 8px; margin-bottom: 4px; font-size: 12px; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

<div id="win-modal">
    <div class="win-box">
        <h2 id="win-title">üéâ ¬°VICTORIA! üéâ</h2>
        <p id="win-text"></p>
        <div class="win-btns">
            <button onclick="copyToClipboard()" style="background:#2196f3; color:white;">üìã COPIAR RESULTADO</button>
            <button onclick="document.getElementById('win-modal').style.display='none'" style="background:#546e7a; color:white;">CERRAR</button>
        </div>
    </div>
</div>

<div id="login-screen" class="overlay">
    <div class="login-box">
        <h2>HIDE CODE ONLINE</h2>
        <input type="text" id="p-name" placeholder="Tu Nombre" style="padding:10px; width:100%; box-sizing: border-box; margin-bottom:10px;">
        <div style="display:flex; gap:10px; align-items:center;">
            <input type="text" id="p-room" placeholder="C√≥d. Sala" style="padding:10px; flex-grow:1;">
            <button onclick="connectMulti()" style="width:auto; padding:10px;">ENTRAR</button>
        </div>
        <hr style="border-color:#546e7a; margin: 20px 0;">
        <button onclick="initSolitaireMenu()" class="solo-btn">PARTIDA EN SOLITARIO</button>
    </div>
</div>

<div class="mode-selector">
    Dise√±o: 
    <select onchange="document.getElementById('w').className = 'wrapper ' + this.value">
        <option value="">Horizontal (Derecha)</option>
        <option value="vertical">Vertical (Abajo)</option>
    </select>
</div>

<div class="digit-reference" id="ref-bar"></div>

<div class="wrapper" id="w">
    <div class="sheet" id="sheet-bg">
        <div class="header-title">HIDE CODE</div>
        <div class="game-grid" id="main-grid"></div>
    </div>

    <div class="ai-panel">
        <h3 id="panel-title">CONFIGURACI√ìN</h3>
        
        <div id="multi-setup" style="display:none;">
            <div class="setup-box" id="setup-area">
                <label style="font-size: 12px; font-weight: bold;">C√≥digo Secreto:</label>
                <div class="setup-inputs">
                    <input type="text" id="s-0" maxlength="1"><input type="text" id="s-1" maxlength="1"><input type="text" id="s-2" maxlength="1"><input type="text" id="s-3" maxlength="1"><input type="text" id="s-4" maxlength="1"><input type="text" id="s-5" maxlength="1">
                </div>
                <button onclick="setManualCode()" style="background: #ffc107;">Fijar C√≥digo</button>
                <button onclick="setRandomCode()" style="background: #8bc34a;">Generar Aleatorio</button>
            </div>
            <div id="turn-display" class="turn-tag">Conectando...</div>
            <div id="player-list-box"></div>
        </div>

        <div id="solo-panel" style="display:none;">
            <div id="solo-controls">
                <button id="btn-solo-rand" onclick="startSolitaire('random')" style="background:#8bc34a; margin-bottom:5px;">Jugar Aleatorio (‚àû)</button>
                <button id="btn-solo-daily" onclick="startSolitaire('daily')" style="background:#ff9800; margin-bottom:15px;">Jugar C√≥digo Diario (1/d√≠a)</button>
            </div>
            <div id="daily-optimal" style="display:none; margin-bottom:15px;">
                <div style="font-size: 12px; font-weight: bold; margin-bottom: 6px;">M√≠nimo te√≥rico: <span id="daily-optimal-count">Calculando...</span></div>
                <button id="btn-daily-optimal" onclick="showNextOptimalStep()" class="solo-btn" style="display:none;">Ver ruta √≥ptima</button>
                <div id="daily-optimal-path" style="display:none; margin-top:8px; font-size:12px; line-height:1.4;"></div>
                <button id="btn-next-hint" onclick="showNextOptimalStep()" class="solo-btn" style="display:none; background:#2196f3; color:white; font-size:11px;">Siguiente Paso ‚Üí</button>
            </div>
            <div id="solo-stats">
                <div class="question-counter">PREGUNTA: <span id="q-counter">0</span> / 25</div>
                <table class="rank-table">
                    <tr><th>Rango</th><th>Turnos</th></tr>
                    <tr><td>Master Hacker</td><td>1 - 7</td></tr>
                    <tr><td colspan="2"><div class="bar-container"><div id="bar-master" class="bar-fill">0%</div></div></td></tr>
                    <tr><td>Cript√≥grafo</td><td>8 - 12</td></tr>
                    <tr><td colspan="2"><div class="bar-container"><div id="bar-crypto" class="bar-fill">0%</div></div></td></tr>
                    <tr><td>Analista</td><td>13 - 18</td></tr>
                    <tr><td colspan="2"><div class="bar-container"><div id="bar-analyst" class="bar-fill">0%</div></div></td></tr>
                    <tr><td>Aprendiz</td><td>19 - 25</td></tr>
                    <tr><td colspan="2"><div class="bar-container"><div id="bar-apprentice" class="bar-fill">0%</div></div></td></tr>
                    <tr><td>Novato</td><td>+25</td></tr>
                    <tr><td colspan="2"><div class="bar-container"><div id="bar-novice" class="bar-fill">0%</div></div></td></tr>
                </table>
            </div>
        </div>

        <h3>INTERROGAR IA</h3>
        
        <div id="questions-block" style="pointer-events: none; opacity: 0.6;">
            <div class="q-box">
                <label>1. Suma de Segmentos</label>
                <div class="q-controls">
                    <select id="q1-v">
                        <optgroup label="Columnas"><option value="A">Columna A</option><option value="B">Columna B</option><option value="C">Columna C</option><option value="D">Columna D</option><option value="E">Columna E</option><option value="F">Columna F</option><option value="G">Columna G</option><option value="H">Columna H</option><option value="I">Columna I</option></optgroup>
                        <optgroup label="Filas"><option value="J">Fila J</option><option value="K">Fila K</option><option value="L">Fila L</option><option value="M">Fila M</option><option value="N">Fila N</option><option value="O">Fila O</option><option value="P">Fila P</option><option value="Q">Fila Q</option><option value="R">Fila R</option><option value="S">Fila S</option></optgroup>
                    </select>
                    <button class="btn-private" onclick="askQ1(true)">üïµÔ∏è</button>
                </div>
                <button onclick="askQ1(false)">Preguntar</button>
            </div>
            <div class="q-box">
                <label>2. Par/Imp o 3. Comparar</label>
                <div class="q-controls">
                    <div style="display:flex; gap:5px; width: 100%;">
                        <select id="q2-1"><option value="0">T</option><option value="1">U</option><option value="2">V</option><option value="3">W</option><option value="4">X</option><option value="5">Y</option></select>
                        <select id="q2-2"><option value="">- Solo Par/Imp -</option><option value="0">T</option><option value="1">U</option><option value="2">V</option><option value="3">W</option><option value="4">X</option><option value="5">Y</option></select>
                    </div>
                    <button class="btn-private" onclick="askQ23(true)">üïµÔ∏è</button>
                </div>
                <button onclick="askQ23(false)">Preguntar</button>
            </div>
            <div class="q-box">
                <label>4. Coordenada Exacta</label>
                <div class="q-controls">
                    <div style="display:flex; gap:5px; width: 100%;"><select id="q4-c"></select><select id="q4-r"></select></div>
                    <button class="btn-private" onclick="askQ4(true)">üïµÔ∏è</button>
                </div>
                <button onclick="askQ4(false)">Preguntar</button>
            </div>
        </div>

        <div id="log"></div>
            
        <div id="resolve-block">
            <button id="btn-resolve" onclick="tryResolve()" style="background:#D32F2F; color:white; margin-top:10px;">RESOLVER C√ìDIGO ‚ù§Ô∏è‚ù§Ô∏è</button>
            <button id="btn-reveal" onclick="reveal()" style="background:#546e7a; color:#fff; margin-top: 10px; display:none;">Ver Soluci√≥n (Solo Dealer)</button>
        </div>
    </div>
</div>

<script>
    const firebaseConfig = { apiKey: "AIzaSyDWST4NKU_roqoGsMAAevs4zd-c4IqAOEU", authDomain: "digitcode-d991e.firebaseapp.com", databaseURL: "https://digitcode-d991e-default-rtdb.europe-west1.firebasedatabase.app", projectId: "digitcode-d991e", storageBucket: "digitcode-d991e.firebasestorage.app", messagingSenderId: "958984288633", appId: "1:958984288633:web:c88980de5de0a5422597a8" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const shapes = {0:[1,1,1,1,1,1,0],1:[0,1,1,0,0,0,0],2:[1,1,0,1,1,0,1],3:[1,1,1,1,0,0,1],4:[0,1,1,0,0,1,1],5:[1,0,1,1,0,1,1],6:[1,0,1,1,1,1,1],7:[1,1,1,0,0,0,0],8:[1,1,1,1,1,1,1],9:[1,1,1,1,0,1,1]};
    const ady = {0:[1,3], 1:[0,2,4], 2:[1,5], 3:[0,4], 4:[1,3,5], 5:[2,4]};
    const names = ['T','U','V','W','X','Y'];
    const playerColors = ['#00e676', '#ffea00', '#ff1744', '#00d2ff', '#e040fb', '#ff9100', '#2979ff', '#1de9b6', '#c6ff00', '#ff5252'];
    
    let secret = null;
    let myName = "";
    let roomId = "";
    let gameMode = "multi"; 
    let soloType = ""; 
    let gameState = null;
    let soloQCount = 0;
    let soloAttempts = 0;
    let lastVictoryMsg = "";
    let localVictoryShown = false;
    let dailyOptimalData = null;
    let currentStepIndex = 0;
    let hintsUsedCount = 0;

    function setQuestionsState(enabled) {
        const qBlock = document.getElementById('questions-block');
        qBlock.style.pointerEvents = enabled ? "auto" : "none";
        qBlock.style.opacity = enabled ? "1" : "0.6";
    }
    
    function connectMulti() {
        myName = document.getElementById('p-name').value.trim().toUpperCase();
        roomId = document.getElementById('p-room').value.trim().toUpperCase();
        if(!myName || !roomId) return alert("Faltan datos");
        gameMode = "multi"; gameState = null; 
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('solo-panel').style.display = 'none';
        document.getElementById('multi-setup').style.display = 'block';
        document.getElementById('panel-title').innerText = "CONFIGURACI√ìN";
        const roomRef = db.ref('rooms/' + roomId);
        roomRef.once('value', snapshot => {
            if(!snapshot.exists()) { roomRef.set({ turn: 0, players: [myName], logs: [{m: "PARTIDA INICIADA", s: "ok", p: "SISTEMA"}], dealer: "", privateUsed: {} }); }
            else { let p = snapshot.val().players || []; if(!p.includes(myName)) { p.push(myName); roomRef.update({ players: p }); } }
            roomRef.on('value', s => { gameState = s.val(); if(gameState) { secret = gameState.secret; syncUI(); checkMultiWinner(); autoFillFromLog(); } });
        });
    }

    function initSolitaireMenu() {
        myName = document.getElementById('p-name').value.trim().toUpperCase();
        if(!myName) return alert("Introduce tu nombre primero");
        gameMode = "solo";
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('multi-setup').style.display = 'none';
        document.getElementById('panel-title').innerText = "SOLITARIO: " + myName;
        document.getElementById('solo-panel').style.display = 'block';
        document.getElementById('solo-controls').style.display = 'block';
        setQuestionsState(false);
        loadSoloStats(); checkDailyStatus();
    }

    // --- NUEVA L√ìGICA DE DEDUCCI√ìN AUTOM√ÅTICA ---
    function autoFillFromLog() {
        if(!gameState || !gameState.logs) return;
        gameState.logs.forEach(log => {
            if (log.isPrivate && log.p !== myName) return; // No auto-rellenar lo que no ves
            applyLogToSheet(log.m);
        });
    }

    function applyLogToSheet(msg) {
        // Q1 Suma: "Suma en A: 3"
        if(msg.startsWith("Suma en ")) {
            let label = msg.split(":")[0].replace("Suma en ", "").trim();
            let val = msg.split(":")[1].trim();
            let inputs = document.querySelectorAll('.label-row input, .abc-item input');
            inputs.forEach(inp => {
                if(inp.parentElement.innerText.trim().startsWith(label)) {
                    if(inp.value === "") {
                        inp.value = val;
                        inp.classList.add('auto-fill');
                    }
                }
            });
        }
        // Q2 Par/Imp: "T es PAR"
        else if(msg.includes(" es ") && (msg.includes("PAR") || msg.includes("IMPAR"))) {
            let parts = msg.split(" es ");
            let dName = parts[0].trim();
            let type = parts[1].trim();
            let block = Array.from(document.querySelectorAll('.digit-block input')).find(i => i.placeholder === dName)?.parentElement;
            if(block) {
                let ind = block.querySelector(`.p-indicator[data-type="${type}"]`);
                if(ind && !ind.classList.contains('active')) {
                    ind.classList.add('active');
                    ind.classList.add('auto-fill');
                }
            }
        }
        // Q3 Comparar: "T > U"
        else if(msg.includes(" > ") || msg.includes(" < ") || msg.includes(" = ")) {
            let symbol = msg.includes(">") ? ">" : (msg.includes("<") ? "<" : "=");
            let parts = msg.split(symbol);
            let d1 = parts[0].trim(); let d2 = parts[1].trim();
            let idx1 = names.indexOf(d1); let idx2 = names.indexOf(d2);
            let pair = [idx1, idx2].sort((a,b)=>a-b);
            let compKey = pair.join('-');
            let compEl = document.querySelector(`.comp[data-pair="${compKey}"]`);
            if(compEl && compEl.innerText === "?") {
                compEl.innerText = symbol;
                compEl.style.background = "#fff59d";
                compEl.classList.add('auto-fill');
                if(compEl.parentElement.classList.contains('v-comps')) compEl.classList.add('rotate-90');
            }
        }
        // Q4 Segmento: "A-J: ENCENDIDO"
        else if(msg.includes(": ENCENDIDO") || msg.includes(": APAGADO")) {
            let parts = msg.split(": ");
            let coord = parts[0];
            let state = parts[1];
            let c = coord.split("-")[0]; let r = coord.split("-")[1];
            const cIdx = ['ABC','DEF','GHI'].findIndex(g => g.includes(c)); 
            const dIdx = cIdx + ('OPQRS'.includes(r) ? 3 : 0);
            const map = {"1-0":"s-a","2-1":"s-b","2-3":"s-c","1-4":"s-d","0-3":"s-e","0-1":"s-f","1-2":"s-g"};
            const cT = ['ADG','BEH','CFI'].findIndex(g => g.includes(c)); 
            const rT = ['JO','KP','LQ','MR','NS'].findIndex(g => g.includes(r));
            const sClass = map[`${cT}-${rT}`];
            let digitBlocks = document.querySelectorAll('.digit-block');
            let targetSeg = digitBlocks[dIdx].querySelector('.' + sClass);
            if(targetSeg) {
                if(state === "ENCENDIDO" && !targetSeg.classList.contains('st-1')) {
                    targetSeg.classList.add('st-1', 'auto-fill');
                } else if(state === "APAGADO" && !targetSeg.classList.contains('st-off-auto')) {
                    targetSeg.classList.add('st-off-auto', 'auto-fill');
                }
            }
        }
    }
    // ---------------------------------------------

    function checkDailyStatus() {
        const dateStr = new Date().toLocaleDateString('es-ES', { timeZone: 'Europe/Madrid' }).replace(/\//g, '');
        db.ref(`users/${myName}/daily/${dateStr}`).once('value', s => {
            const btn = document.getElementById('btn-solo-daily');
            if(s.exists()) { btn.classList.add('btn-disabled'); btn.innerHTML = "C√≥digo Diario (JUGADO)"; btn.onclick = null; }
            else { btn.classList.remove('btn-disabled'); btn.innerHTML = "Jugar C√≥digo Diario (1/d√≠a)"; btn.onclick = () => startSolitaire('daily'); }
        });
    }

    function loadSoloStats() {
        db.ref('users/' + myName + '/stats').once('value', s => {
            let stats = s.val() || {}; let total = stats.total || 0;
            const updateBar = (id, val) => {
                let pct = total > 0 ? Math.round((val/total)*100) : 0;
                let el = document.getElementById(id); el.style.width = pct + "%"; el.innerText = pct + "%";
            };
            if(total >= 0) { updateBar('bar-master', stats.master || 0); updateBar('bar-crypto', stats.crypto || 0); updateBar('bar-analyst', stats.analyst || 0); updateBar('bar-apprentice', stats.apprentice || 0); updateBar('bar-novice', stats.novice || 0); }
        });
    }

    function resetBoard() {
        document.querySelectorAll('.seg').forEach(s => s.classList.remove('st-1', 'st-off-auto', 'auto-fill'));
        document.querySelectorAll('.num-pick').forEach(n => n.classList.remove('scratched'));
        document.querySelectorAll('input').forEach(i => { 
            if(i.id.indexOf('p-') === -1 && i.id.indexOf('s-') === -1) {
                i.value = ""; i.classList.remove('auto-fill');
            }
        });
        document.querySelectorAll('.comp').forEach(c => { 
            c.innerText = "?"; c.style.background = "white"; c.classList.remove('rotate-90', 'auto-fill'); 
        });
        document.querySelectorAll('.p-indicator').forEach(p => p.classList.remove('active', 'auto-fill'));
    }

    function startSolitaire(type) {
        if(type === 'daily') { if(document.getElementById('btn-solo-daily').classList.contains('btn-disabled')) return; }
        soloType = type; soloQCount = 0; soloAttempts = 0; hintsUsedCount = 0;
        document.getElementById('q-counter').innerText = "0";
        document.getElementById('log').innerHTML = "";
        resetBoard();
        document.getElementById('solo-controls').style.display = 'none';
        document.getElementById('daily-optimal').style.display = type === 'daily' ? 'block' : 'none';
        document.getElementById('daily-optimal-count').innerText = "Calculando...";
        document.getElementById('daily-optimal-path').style.display = 'none';
        document.getElementById('daily-optimal-path').innerText = "";
        document.getElementById('btn-daily-optimal').style.display = 'none';
        document.getElementById('btn-next-hint').style.display = 'none';
        document.getElementById('btn-next-hint').disabled = false;
        document.getElementById('btn-next-hint').style.opacity = "1";
        document.getElementById('btn-next-hint').innerText = "Siguiente Paso ‚Üí";
        dailyOptimalData = null;
        currentStepIndex = 0;
        if(type === 'daily') {
            const dateStr = new Date().toLocaleDateString('es-ES', { timeZone: 'Europe/Madrid' }).replace(/\//g, '');
            secret = generateDailyCode(dateStr); activateSoloGame();
            setTimeout(() => { computeDailyOptimalPlan(); }, 50);
        } else { secret = generateRandomCode(); activateSoloGame(); }
    }

    function activateSoloGame() {
        setQuestionsState(true);
        document.getElementById('btn-resolve').innerHTML = "RESOLVER C√ìDIGO ‚ù§Ô∏è‚ù§Ô∏è";
        document.getElementById('btn-resolve').disabled = false;
        document.getElementById('btn-resolve').style.background = "#D32F2F";
        logSolo("Partida iniciada. Modo: " + (soloType==='daily'?'DIARIO':'ALEATORIO'));
    }

    function logSolo(msg, color="#00e676") {
        const lBox = document.getElementById('log');
        lBox.innerHTML = `<span style="color:${color}">[${soloQCount}] ${msg}</span><br>` + lBox.innerHTML;
        applyLogToSheet(msg); // AUTOFILL SOLITARIO
    }

    function generateRandomCode() {
        let temp = [null,null,null,null,null,null];
        for(let i=0; i<6; i++) {
            let forbid = []; ady[i].forEach(n => { if(temp[n]!==null) forbid.push(temp[n]); });
            let poss = [0,1,2,3,4,5,6,7,8,9].filter(x => !forbid.includes(x));
            temp[i] = poss[Math.floor(Math.random()*poss.length)];
        }
        return temp;
    }

    function generateDailyCode(seedStr) {
        let seed = parseInt(seedStr);
        const random = function() { var t = seed += 0x6D2B79F5; t = Math.imul(t ^ t >>> 15, t | 1); t ^= t + Math.imul(t ^ t >>> 7, t | 61); return ((t ^ t >>> 14) >>> 0) / 4294967296; };
        let temp = [null,null,null,null,null,null];
        for(let i=0; i<6; i++) {
            let forbid = []; ady[i].forEach(n => { if(temp[n]!==null) forbid.push(temp[n]); });
            let poss = [0,1,2,3,4,5,6,7,8,9].filter(x => !forbid.includes(x));
            temp[i] = poss[Math.floor(random()*poss.length)];
        }
        return temp;
    }

    function getAllValidCodes() {
        let codes = [];
        let temp = [null,null,null,null,null,null];
        const digits = [0,1,2,3,4,5,6,7,8,9];
        const fill = (idx) => {
            if(idx === 6) { codes.push(temp.slice()); return; }
            for(const d of digits) {
                let ok = true;
                for(const n of ady[idx]) {
                    if(n < idx && temp[n] === d) { ok = false; break; }
                }
                if(!ok) continue;
                temp[idx] = d;
                fill(idx + 1);
                temp[idx] = null;
            }
        };
        fill(0);
        return codes;
    }

    function getQ4Coords() {
        const coords = [];
        const cols = 'ABCDEFGHI'.split('');
        const rows = 'JKLMNOPQRS'.split('');
        const map = {"1-0":0,"2-1":1,"2-3":2,"1-4":3,"0-3":4,"0-1":5,"1-2":6};
        cols.forEach(c => rows.forEach(r => {
            const cT = ['ADG','BEH','CFI'].findIndex(g => g.includes(c));
            const rT = ['JO','KP','LQ','MR','NS'].findIndex(g => g.includes(r));
            const sIdx = map[`${cT}-${rT}`];
            if(sIdx !== undefined) coords.push({ c, r });
        }));
        return coords;
    }

    function getDailyQuestions() {
        const questions = [];
        'ABCDEFGHI'.split('').forEach(v => questions.push({ type: 'q1', v }));
        'JKLMNOPQRS'.split('').forEach(v => questions.push({ type: 'q1', v }));
        names.forEach((_, idx) => questions.push({ type: 'parity', idx }));
        const pairs = [[0,1],[0,3],[1,2],[1,4],[2,5],[3,4],[4,5]];
        pairs.forEach(pair => questions.push({ type: 'compare', pair }));
        getQ4Coords().forEach(coord => questions.push({ type: 'q4', coord }));
        return questions;
    }

    function answerFor(code, question) {
        if(question.type === 'q1') {
            const v = question.v;
            const colMap = {'A':[0,3,[5,4]],'B':[0,3,[0,6,3]],'C':[0,3,[1,2]],'D':[1,4,[5,4]],'E':[1,4,[0,6,3]],'F':[1,4,[1,2]],'G':[2,5,[5,4]],'H':[2,5,[0,6,3]],'I':[2,5,[1,2]]};
            const rowMap = {'J':[[0,1,2],[0]],'K':[[0,1,2],[5,1]],'L':[[0,1,2],[6]],'M':[[0,1,2],[4,2]],'N':[[0,1,2],[3]],'O':[[3,4,5],[0]],'P':[[3,4,5],[5,1]],'Q':[[3,4,5],[6]],'R':[[3,4,5],[4,2]],'S':[[3,4,5],[3]]};
            let c = 0;
            if(colMap[v]) colMap[v].slice(0,2).forEach(d=>colMap[v][2].forEach(s=>{if(shapes[code[d]][s])c++;}));
            else rowMap[v][0].forEach(d=>rowMap[v][1].forEach(s=>{if(shapes[code[d]][s])c++;}));
            return c.toString();
        }
        if(question.type === 'parity') {
            return code[question.idx] % 2 === 0 ? 'PAR' : 'IMPAR';
        }
        if(question.type === 'compare') {
            const [d1, d2] = question.pair;
            if(code[d1] > code[d2]) return '>';
            if(code[d1] < code[d2]) return '<';
            return '=';
        }
        if(question.type === 'q4') {
            const c = question.coord.c;
            const r = question.coord.r;
            const cIdx = ['ABC','DEF','GHI'].findIndex(g => g.includes(c));
            const dIdx = cIdx + ('OPQRS'.includes(r) ? 3 : 0);
            const map = {"1-0":0,"2-1":1,"2-3":2,"1-4":3,"0-3":4,"0-1":5,"1-2":6};
            const cT = ['ADG','BEH','CFI'].findIndex(g => g.includes(c));
            const rT = ['JO','KP','LQ','MR','NS'].findIndex(g => g.includes(r));
            const sIdx = map[`${cT}-${rT}`];
            return shapes[code[dIdx]][sIdx] ? 'ENCENDIDO' : 'APAGADO';
        }
        return '';
    }

    function questionLabel(question) {
        if(question.type === 'q1') return `Q1 ${question.v}`;
        if(question.type === 'parity') return `Q2 ${names[question.idx]} PAR/IMP`;
        if(question.type === 'compare') return `Q3 ${names[question.pair[0]]} vs ${names[question.pair[1]]}`;
        if(question.type === 'q4') return `Q4 ${question.coord.c}-${question.coord.r}`;
        return '';
    }

    function computeDailyOptimalPlan() {
        if(soloType !== 'daily' || !secret) return;
        const candidates = getAllValidCodes();
        const secretStr = secret.join('');
        const questions = getDailyQuestions();
        const secretAnswers = questions.map(q => answerFor(secret, q));

        const iddfs = (candidateIdxs, depth, path) => {
            if(candidateIdxs.length === 1) return true;
            if(depth === 0) return false;
            const minBound = Math.ceil(Math.log2(candidateIdxs.length));
            if(minBound > depth) return false;
            const ranked = [];
            for(let q = 0; q < questions.length; q++) {
                const next = [];
                const answer = secretAnswers[q];
                for(const idx of candidateIdxs) {
                    if(answerFor(candidates[idx], questions[q]) === answer) next.push(idx);
                }
                if(next.length < candidateIdxs.length) ranked.push({ q, next });
            }
            ranked.sort((a, b) => a.next.length - b.next.length);
            for(const option of ranked) {
                path.push(option.q);
                if(iddfs(option.next, depth - 1, path)) return true;
                path.pop();
            }
            return false;
        };

        const initial = candidates.map((_, idx) => idx);
        let depth = 0;
        let plan = [];
        while(true) {
            plan = [];
            if(iddfs(initial, depth, plan)) break;
            depth++;
        }

        dailyOptimalData = {
            secret: secretStr,
            steps: plan.map(qIdx => ({
                label: questionLabel(questions[qIdx]),
                answer: secretAnswers[qIdx]
            }))
        };

        document.getElementById('daily-optimal-count').innerText = `${dailyOptimalData.steps.length} preguntas`;
        document.getElementById('btn-daily-optimal').style.display = 'block';
    }

    function showNextOptimalStep() {
        if(!dailyOptimalData) return;
        const pathBox = document.getElementById('daily-optimal-path');
        const nextBtn = document.getElementById('btn-next-hint');
        const startBtn = document.getElementById('btn-daily-optimal');
        
        if (currentStepIndex < dailyOptimalData.steps.length) {
            startBtn.style.display = 'none';
            pathBox.style.display = 'block';
            nextBtn.style.display = 'block';
            
            const step = dailyOptimalData.steps[currentStepIndex];
            const stepHtml = `<div class="hint-step"><strong>Paso ${currentStepIndex + 1}:</strong> ${step.label} ‚Üí <span style="color:#2196f3">${step.answer}</span></div>`;
            pathBox.innerHTML += stepHtml;
            
            currentStepIndex++;
            hintsUsedCount++; 
            
            if (currentStepIndex >= dailyOptimalData.steps.length) {
                nextBtn.innerText = "¬°Ruta completada!";
                nextBtn.disabled = true;
                nextBtn.style.opacity = "0.5";
            }
        }
    }

    function syncUI() {
        if(gameMode !== 'multi') return;
        if(!gameState || !gameState.players) return;
        const curIdx = gameState.turn % gameState.players.length;
        const curPlayer = gameState.players[curIdx];
        const isMyTurn = curPlayer === myName;
        const banner = document.getElementById('turn-display');
        banner.innerText = isMyTurn ? "¬°TU TURNO!" : "TURNO: " + curPlayer;
        banner.className = "turn-tag " + (isMyTurn ? "active" : "");
        setQuestionsState(isMyTurn);
        const hasUsedPrivate = gameState.privateUsed && gameState.privateUsed[myName];
        document.querySelectorAll('.btn-private').forEach(b => b.style.display = (isMyTurn && !hasUsedPrivate) ? 'block' : 'none');
        if(isMyTurn) { const playerIdx = gameState.players.indexOf(curPlayer); document.getElementById('sheet-bg').style.backgroundColor = playerColors[playerIdx % playerColors.length] + "08"; } 
        else { document.getElementById('sheet-bg').style.backgroundColor = "#ffffff"; }
        let pListHtml = "";
        gameState.players.forEach((p, i) => {
            let color = playerColors[i % playerColors.length];
            let isCurrent = (curPlayer === p);
            let marker = isCurrent ? "‚ñ∂ " : "&nbsp;&nbsp;";
            pListHtml += `<div class="pl-row" style="color:${color}; font-weight:${isCurrent?900:400}"><span>${marker}${p}</span></div>`;
        });
        document.getElementById('player-list-box').innerHTML = pListHtml;
        if(secret) document.getElementById('setup-area').style.display = 'none';
        else document.getElementById('setup-area').style.display = 'block'; 
        document.getElementById('btn-reveal').style.display = (gameState.dealer === myName) ? 'block' : 'none';
        const attempts = (gameState.attempts && gameState.attempts[myName]) || 0;
        const lastFail = (gameState.lastFailTurn && gameState.lastFailTurn[myName]) || -1;
        const btnResolve = document.getElementById('btn-resolve');
        let hearts = attempts === 0 ? "‚ù§Ô∏è‚ù§Ô∏è" : (attempts === 1 ? "‚ù§Ô∏èüñ§" : "üñ§üñ§");
        let onCooldown = (attempts === 1 && gameState.turn < lastFail + gameState.players.length);
        if(attempts >= 2) { btnResolve.innerHTML = `ELIMINADO ${hearts}`; btnResolve.disabled = true; btnResolve.style.background = "#555"; }
        else if (onCooldown) { btnResolve.innerHTML = `ESPERANDO TURNO... ${hearts}`; btnResolve.disabled = true; btnResolve.style.background = "#ffb74d"; }
        else { btnResolve.innerHTML = `RESOLVER C√ìDIGO ${hearts}`; btnResolve.disabled = false; btnResolve.style.background = "#D32F2F"; }
        const lBox = document.getElementById('log');
        lBox.innerHTML = (gameState.logs || []).map((l, i) => {
            let color = l.p === "SISTEMA" ? "#00e676" : (playerColors[gameState.players.indexOf(l.p) % playerColors.length] || "#fff");
            let message = l.m; if (l.isPrivate && l.p !== myName) { message = "üïµÔ∏è RESPUESTA PRIVADA (Solo √©l conoce el dato)"; color = "#9c27b0"; }
            return `<span style="color:${color}">[#${i+1}] ${l.p}: ${message}</span>`;
        }).reverse().join('<br>');
    }

    function checkMultiWinner() {
        if(gameMode !== 'multi' || localVictoryShown) return;
        const winnerLog = (gameState.logs || []).find(l => l.m.includes("¬°GANADOR:"));
        if(winnerLog) {
            localVictoryShown = true;
            const participants = (gameState.players || []).join(', ');
            lastVictoryMsg = `¬°FINAL DE PARTIDA! üèÜ ${winnerLog.m} en la Sala: ${roomId}. Participantes: ${participants}. üß†‚ú® #HideCodeMaster`;
            document.getElementById('win-title').innerText = "¬°PARTIDA FINALIZADA!";
            document.getElementById('win-text').innerText = lastVictoryMsg;
            document.getElementById('win-modal').style.display = 'flex';
        }
    }

    function checkSoloLimit() {
        if(gameMode === 'solo') {
            soloQCount++; document.getElementById('q-counter').innerText = soloQCount;
            if(soloQCount > 25) {
                alert("¬°L√çMITE CR√çTICO ALCANZADO! Has perdido.");
                setQuestionsState(false);
                document.getElementById('btn-resolve').disabled = true;
                logSolo("DERROTA POR TIEMPO", "#ff1744"); saveSoloResult('loss'); return false;
            }
        }
        return true;
    }

    window.tryResolve = () => {
        const guess = prompt("INTRODUCE EL C√ìDIGO DE 6 D√çGITOS:");
        if(!guess) return;
        if(gameMode === 'solo') {
            if(guess === secret.join('')) {
                let rankLabel = soloQCount <= 7 ? "Master Hacker üéñÔ∏è" : (soloQCount <= 12 ? "Cript√≥grafo üïµÔ∏è" : (soloQCount <= 18 ? "Analista üìä" : (soloQCount <= 25 ? "Aprendiz üìö" : "Novato üå±")));
                let rankKey = soloQCount <= 7 ? "master" : (soloQCount <= 12 ? "crypto" : (soloQCount <= 18 ? "analyst" : (soloQCount <= 25 ? "apprentice" : "novice")));
                const today = new Date().toLocaleDateString('es-ES');
                const tipoStr = (soloType === 'daily') ? `diario del d√≠a ${today}` : `aleatorio`;
                let dailyInfo = "";
                if(soloType === 'daily' && dailyOptimalData) {
                    dailyInfo = `\n\nüéØ M√≠nimo te√≥rico: ${dailyOptimalData.steps.length} turnos.\nüí° Pistas usadas: ${hintsUsedCount}.`;
                }
                lastVictoryMsg = `¬°VICTORIA! üèÜ Has logrado descifrar el c√≥digo secreto ${tipoStr} en ${soloQCount} turnos. Rango alcanzado: ${rankLabel}.${dailyInfo} üß†‚ú® #HideCodeMaster`;
                logSolo(`¬°VICTORIA! El c√≥digo es ${secret.join('')}`, "#4caf50");
                document.getElementById('win-title').innerText = "üéâ ¬°VICTORIA! üéâ";
                document.getElementById('win-text').innerText = lastVictoryMsg;
                document.getElementById('win-modal').style.display = 'flex';
                saveSoloResult(rankKey);
                setQuestionsState(false);
                document.getElementById('btn-resolve').disabled = true;
            } else {
                soloAttempts++;
                if(soloAttempts >= 2) { 
                    logSolo(`ELIMINADO. El c√≥digo era ${secret.join('')}`, "#ff1744");
                    alert("ELIMINADO. C√≥digo: " + secret.join('')); saveSoloResult('loss'); 
                    setQuestionsState(false);
                    document.getElementById('btn-resolve').disabled = true; 
                } else { alert("C√≥digo incorrecto. 1 vida."); document.getElementById('btn-resolve').innerHTML = "RESOLVER C√ìDIGO ‚ù§Ô∏èüñ§"; }
            }
            return;
        }
        const attempts = (gameState.attempts && gameState.attempts[myName]) || 0;
        const newAttempts = {...(gameState.attempts || {})}; newAttempts[myName] = attempts + 1;
        const newFailTurn = {...(gameState.lastFailTurn || {})};
        if(guess === secret.join('')) {
            let newLogs = gameState.logs || []; newLogs.push({ m: `¬°GANADOR: ${myName}! C√≥digo: ${secret.join('')}`, p: myName, s: 'ok' });
            db.ref('rooms/' + roomId).update({ logs: newLogs, turn: gameState.turn + 1 });
        } else {
            newFailTurn[myName] = gameState.turn;
            let newLogs = gameState.logs || []; newLogs.push({ m: `FALL√ì EL C√ìDIGO`, p: myName, s: 'error' });
            db.ref('rooms/' + roomId).update({ attempts: newAttempts, lastFailTurn: newFailTurn, logs: newLogs, turn: gameState.turn + 1 });
        }
    };

    function copyToClipboard() {
        navigator.clipboard.writeText(lastVictoryMsg).then(() => {
            alert("¬°Resultado copiado al portapapeles!");
        });
    }

    function saveSoloResult(rank) {
        const userRef = db.ref('users/' + myName);
        userRef.child('stats').transaction(current => {
            current = current || { total: 0, master: 0, crypto: 0, analyst: 0, apprentice: 0, novice: 0, loss: 0 };
            current.total++; if(current[rank] !== undefined) current[rank]++; return current;
        }, (err, committed, s) => { if(committed) { loadSoloStats(); checkDailyStatus(); } });
        if(soloType === 'daily') { const dateStr = new Date().toLocaleDateString('es-ES', { timeZone: 'Europe/Madrid' }).replace(/\//g, ''); userRef.child('daily/' + dateStr).set(true); }
        document.getElementById('solo-controls').style.display = 'block';
    }

    window.askQ1 = (isPrivate) => {
        if(!checkSoloLimit()) return;
        const v = document.getElementById('q1-v').value;
        const colMap = {'A':[0,3,[5,4]],'B':[0,3,[0,6,3]],'C':[0,3,[1,2]],'D':[1,4,[5,4]],'E':[1,4,[0,6,3]],'F':[1,4,[1,2]],'G':[2,5,[5,4]],'H':[2,5,[0,6,3]],'I':[2,5,[1,2]]};
        const rowMap = {'J':[[0,1,2],[0]],'K':[[0,1,2],[5,1]],'L':[[0,1,2],[6]],'M':[[0,1,2],[4,2]],'N':[[0,1,2],[3]],'O':[[3,4,5],[0]],'P':[[3,4,5],[5,1]],'Q':[[3,4,5],[6]],'R':[[3,4,5],[4,2]],'S':[[3,4,5],[3]]};
        let c = 0; if(colMap[v]) colMap[v].slice(0,2).forEach(d=>colMap[v][2].forEach(s=>{if(shapes[secret[d]][s])c++}));
        else rowMap[v][0].forEach(d=>rowMap[v][1].forEach(s=>{if(shapes[secret[d]][s])c++}));
        let msg = `Suma en ${v}: ${c}`; if(gameMode === 'solo') logSolo(msg); else sendMultiLog(msg, isPrivate);
    };

    window.askQ23 = (isPrivate) => {
        if(!checkSoloLimit()) return;
        const d1 = parseInt(document.getElementById('q2-1').value); const d2v = document.getElementById('q2-2').value;
        let msg = ""; let isErr = false;
        if(d2v === "") msg = `${names[d1]} es ${secret[d1]%2===0?'PAR':'IMPAR'}`;
        else { const d2 = parseInt(d2v); if(!ady[d1].includes(d2)) { msg = "Error: No adyacentes"; isErr = true; }
            else { let res = secret[d1] > secret[d2] ? '>' : (secret[d1] < secret[d2] ? '<' : '='); msg = `${names[d1]} ${res} ${names[d2]}`; } }
        if(gameMode === 'solo') logSolo(msg, isErr?'#ff1744':'#00e676'); else sendMultiLog(msg, isPrivate, isErr);
    };

    window.askQ4 = (isPrivate) => {
        if(!checkSoloLimit()) return;
        const c = document.getElementById('q4-c').value; const r = document.getElementById('q4-r').value;
        const cIdx = ['ABC','DEF','GHI'].findIndex(g => g.includes(c)); const dIdx = cIdx + ('OPQRS'.includes(r) ? 3 : 0);
        const map = {"1-0":0,"2-1":1,"2-3":2,"1-4":3,"0-3":4,"0-1":5,"1-2":6};
        const cT = ['ADG','BEH','CFI'].findIndex(g => g.includes(c)); const rT = ['JO','KP','LQ','MR','NS'].findIndex(g => g.includes(r));
        const sIdx = map[`${cT}-${rT}`];
        let msg = sIdx!==undefined ? `${c}-${r}: ${shapes[secret[dIdx]][sIdx]?'ENCENDIDO':'APAGADO'}` : "Coord no v√°lida";
        if(gameMode === 'solo') logSolo(msg); else sendMultiLog(msg, isPrivate);
    };

    function sendMultiLog(msg, isPrivate, isErr = false) {
        let l = gameState.logs || []; l.push({ m: msg, p: myName, s: isErr?'error':'ok', isPrivate: isPrivate });
        let updates = { logs: l, turn: gameState.turn + 1 };
        if (isPrivate) { let used = gameState.privateUsed || {}; used[myName] = true; updates.privateUsed = used; }
        db.ref('rooms/' + roomId).update(updates);
    }

    window.setManualCode = () => {
        let temp = []; for(let i=0; i<6; i++) { let v=document.getElementById('s-'+i).value; if(v===""||isNaN(v))return alert("Error"); temp.push(parseInt(v)); }
        for(let i=0; i<6; i++) { for(let n of ady[i]) { if(temp[i] === temp[n]) return alert("Adyacentes iguales"); } }
        localVictoryShown = false;
        db.ref('rooms/'+roomId).update({secret:temp, dealer:myName, logs:[{m:"C√ìDIGO MANUAL", s:"ok", p:"SISTEMA"}], attempts: {}, lastFailTurn: {}});
    };
    window.setRandomCode = () => { 
        localVictoryShown = false;
        db.ref('rooms/'+roomId).update({secret:generateRandomCode(), dealer:myName, logs:[{m:"ALEATORIO GENERADO", s:"ok", p:"SISTEMA"}], attempts: {}, lastFailTurn: {}}); 
    };
    window.reveal = () => { if(gameMode === 'multi' && gameState.dealer === myName) { let l = gameState.logs || []; l.push({m:`SOLUCI√ìN: ${secret.join('-')}`, p:myName, s:'ok'}); db.ref('rooms/'+roomId).update({logs:l}); } };
    window.m = (el) => { if(el.classList.contains('st-1')) el.classList.remove('st-1'); else if(el.classList.contains('st-off-auto')) el.classList.remove('st-off-auto'); else el.classList.add('st-1'); };
    window.cyc = (el) => { const s = ['?', '>', '<', '=']; let next = (s.indexOf(el.innerText)+1)%4; el.innerText = s[next]; el.style.background = s[next] === '?' ? 'white' : '#fff59d'; if(el.parentElement.classList.contains('v-comps')) { if(s[next]!=='?') el.classList.add('rotate-90'); else el.classList.remove('rotate-90'); } };

    (function(){
        const bar = document.getElementById('ref-bar');
        for(let i=0; i<=9; i++) {
            let res = shapes[i]; bar.innerHTML += `<div class="ref-item"><div class="ref-num">${i}</div><div class="mini-seg-grid"><div class="ms m-h ${res[0]?'active-ref':''}" style="top:0"></div><div class="ms m-v ${res[5]?'active-ref':''}" style="top:2px;left:0"></div><div class="ms m-v ${res[1]?'active-ref':''}" style="top:2px;right:0"></div><div class="ms m-h ${res[6]?'active-ref':''}" style="top:16px"></div><div class="ms m-v ${res[4]?'active-ref':''}" style="top:18px;left:0"></div><div class="ms m-v ${res[2]?'active-ref':''}" style="top:18px;right:0"></div><div class="ms m-h ${res[3]?'active-ref':''}" style="bottom:0"></div></div></div>`;
        }
        const grid = document.getElementById('main-grid');
        let html = '<div class="labels-side">'; 'JKLMN'.split('').forEach(l => html += `<div class="label-row">${l}<input></div>`); html += '</div>';
        [0,1,2].forEach(i => {
            const pairKey = i < 2 ? `${i}-${i+1}` : null;
            html += `<div class="digit-block"><div class="abc-header">${[['A','B','C'],['D','E','F'],['G','H','I']][i].map(l=>`<div class="abc-item">${l}<input></div>`).join('')}</div><div class="digit-visual">${['s-a','s-b','s-c','s-d','s-e','s-f','s-g'].map(s=>`<div class="seg ${s=='s-a'||s=='s-g'||s=='s-d'?'seg-h':'seg-v'} ${s}" onclick="m(this)"></div>`).join('')}</div><div class="scratch-pad">${[0,2,4,6,8].map(n=>`<div class="num-pick" onclick="this.classList.toggle('scratched')">${n}</div>`).join('')}${[1,3,5,7,9].map(n=>`<div class="num-pick" onclick="this.classList.toggle('scratched')">${n}</div>`).join('')}</div><div class="parity-container"><div class="p-indicator" data-type="PAR" onclick="this.classList.toggle('active')">P</div><div class="p-indicator" data-type="IMPAR" onclick="this.classList.toggle('active')">I</div></div><input style="margin-top:5px; width:50px; text-align:center; font-weight:bold" placeholder="${names[i]}"></div>`;
            if(i < 2) html += `<div class="comp" data-pair="${pairKey}" onclick="cyc(this)">?</div>`;
        });
        html += `<div class="v-comps">
            <div class="comp" data-pair="0-3" onclick="cyc(this)">?</div>
            <div class="comp" data-pair="1-4" onclick="cyc(this)">?</div>
            <div class="comp" data-pair="2-5" onclick="cyc(this)">?</div>
        </div>`;
        html += '<div class="labels-side">'; 'OPQRS'.split('').forEach(l => html += `<div class="label-row">${l}<input></div>`); html += '</div>';
        [3,4,5].forEach(i => {
            const pairKey = i < 5 ? `${i}-${i+1}` : null;
            html += `<div class="digit-block bottom-row"><div class="digit-visual">${['s-a','s-b','s-c','s-d','s-e','s-f','s-g'].map(s=>`<div class="seg ${s=='s-a'||s=='s-g'||s=='s-d'?'seg-h':'seg-v'} ${s}" onclick="m(this)"></div>`).join('')}</div><div class="scratch-pad">${[0,2,4,6,8].map(n=>`<div class="num-pick" onclick="this.classList.toggle('scratched')">${n}</div>`).join('')}${[1,3,5,7,9].map(n=>`<div class="num-pick" onclick="this.classList.toggle('scratched')">${n}</div>`).join('')}</div><div class="parity-container"><div class="p-indicator" data-type="PAR" onclick="this.classList.toggle('active')">P</div><div class="p-indicator" data-type="IMPAR" onclick="this.classList.toggle('active')">I</div></div><input style="margin-top:5px; width:50px; text-align:center; font-weight:bold" placeholder="${names[i]}"></div>`;
            if(i < 5) html += `<div class="comp" data-pair="${pairKey}" onclick="cyc(this)">?</div>`;
        });
        grid.innerHTML = html;
        document.getElementById('q4-c').innerHTML = 'ABCDEFGHI'.split('').map(v => `<option value="${v}">${v}</option>`).join('');
        document.getElementById('q4-r').innerHTML = 'JKLMNOPQRS'.split('').map(v => `<option value="${v}">${v}</option>`).join('');
    })();
</script>
</body>
</html>
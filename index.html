<!DOCTYPE html>
<html lang="es">
<head>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <script>
        if(!sessionStorage.getItem('reloaded')) {
            sessionStorage.setItem('reloaded', '1');
            location.reload(true);
        }
    </script>
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta charset="UTF-8">
    <title>Hide Code - Master Edition Online</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">

    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>

    <style>
        :root { 
            --bg-dark: #0f172a;
            --glass-bg: rgba(30, 41, 59, 0.7);
            --glass-border: rgba(255, 255, 255, 0.1);
            --neon-blue: #38bdf8;
            --neon-green: #4ade80;
            --neon-red: #f87171;
            --neon-purple: #c084fc;
            --neon-orange: #fbbf24;
            --text-main: #e2e8f0;
            --text-muted: #94a3b8;
            
            --seg-off: #334155;
            --seg-on: #38bdf8;
            
            --seg-h-thick: 10px;
            --digit-h: 120px;
        }
        
        body { 
            font-family: 'Roboto', sans-serif; 
            background: radial-gradient(circle at top left, #1e293b, #0f172a);
            color: var(--text-main);
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            padding: 20px; 
            margin: 0; 
            min-height: 100vh;
        }

        /* --- UI COMPONENTS --- */
        
        .mode-selector { 
            background: var(--glass-bg); 
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            padding: 10px 20px; 
            border-radius: 12px; 
            margin-bottom: 20px; 
            font-size: 14px; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        select {
            background: #1e293b;
            color: white;
            border: 1px solid #475569;
            padding: 5px 10px;
            border-radius: 6px;
            outline: none;
        }

        /* Barra de referencia superior */
        .digit-reference { 
            display: flex; 
            gap: 15px; 
            background: var(--glass-bg);
            backdrop-filter: blur(5px);
            padding: 15px 25px; 
            border-radius: 16px; 
            margin-bottom: 20px; 
            border: 1px solid var(--glass-border);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2);
            overflow-x: auto;
            max-width: 100%;
        }
        
        .ref-item { display: flex; flex-direction: column; align-items: center; opacity: 0.6; transition: 0.3s; }
        .ref-item:hover { opacity: 1; transform: scale(1.1); }
        .ref-num { font-weight: bold; color: var(--neon-blue); margin-bottom: 5px; font-family: 'Orbitron', sans-serif; }
        
        .mini-seg-grid { position: relative; width: 20px; height: 35px; }
        .ms { position: absolute; background: #475569; border-radius: 2px; }
        .m-h { height: 3px; left: 4px; right: 4px; }
        .m-v { width: 3px; height: 12px; }
        .active-ref { background: var(--neon-blue) !important; box-shadow: 0 0 5px var(--neon-blue); }

        /* Contenedor Principal */
        .wrapper { display: flex; gap: 20px; max-width: 1400px; width: 100%; transition: all 0.5s; }
        .wrapper.vertical { flex-direction: column; align-items: center; }
        
        /* --- HOJA DE DEDUCCI√ìN (Tablero) --- */
        .sheet { 
            background: rgba(15, 23, 42, 0.6); 
            backdrop-filter: blur(12px);
            padding: 30px; 
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5); 
            border-radius: 20px; 
            flex-grow: 1; 
            border: 1px solid var(--glass-border); 
            position: relative;
        }
        
        .header-title { 
            text-align: center; 
            font-family: 'Orbitron', sans-serif; 
            font-weight: 900; 
            font-size: 32px; 
            margin-bottom: 20px; 
            letter-spacing: 2px;
            background: linear-gradient(90deg, var(--neon-blue), var(--neon-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 20px rgba(56, 189, 248, 0.3);
            border-bottom: 1px solid var(--glass-border);
            padding-bottom: 15px;
        }
        
        /* BARRA DE HERRAMIENTAS */
        .tools-bar { 
            display: flex; gap: 12px; justify-content: center; margin-bottom: 20px; 
            padding: 8px 16px; background: rgba(0,0,0,0.3); border-radius: 30px; 
            width: fit-content; margin-left: auto; margin-right: auto; border: 1px solid var(--glass-border);
        }
        .tool-btn { 
            background: transparent; border: 1px solid #475569; border-radius: 50%; 
            width: 40px; height: 40px; cursor: pointer; display: flex; align-items: center; justify-content: center; 
            color: var(--text-main); transition: all 0.2s; 
        }
        .tool-btn svg { width: 18px; height: 18px; fill: currentColor; }
        .tool-btn:hover:not(:disabled) { background: var(--neon-blue); color: #000; border-color: var(--neon-blue); box-shadow: 0 0 10px var(--neon-blue); }
        .tool-btn:active:not(:disabled) { transform: scale(0.95); }
        .tool-btn.btn-clear:hover { background: var(--neon-red); color: #fff; border-color: var(--neon-red); box-shadow: 0 0 10px var(--neon-red); }
        .tool-btn:disabled { opacity: 0.3; cursor: not-allowed; border-color: #334155; }

        .game-grid { display: grid; grid-template-columns: 60px 1fr 40px 1fr 40px 1fr; align-items: start; gap: 10px; }
        
        /* Etiquetas laterales */
        .labels-side { display: flex; flex-direction: column; border-right: 2px solid #334155; padding-right: 15px; margin-top: 42px; } 
        .label-row { display: flex; align-items: center; justify-content: flex-end; gap: 8px; height: var(--seg-h-thick); margin-bottom: 15px; font-weight: bold; font-size: 14px; color: var(--text-muted); font-family: 'Orbitron', sans-serif; }
        .label-row:last-child { margin-bottom: 0; }
        
        input { 
            background: transparent; border: none; border-bottom: 1px solid #475569; 
            color: var(--neon-orange); text-align: center; font-weight: bold; font-family: 'Orbitron', sans-serif;
            transition: 0.3s;
        }
        input:focus { border-bottom-color: var(--neon-blue); outline: none; }
        .label-row input { width: 25px; height: 18px; font-size: 12px; }

        /* Bloque D√≠gito */
        .digit-block { display: flex; flex-direction: column; align-items: center; padding: 10px; background: rgba(255,255,255,0.02); border-radius: 10px; border: 1px solid transparent; transition: 0.3s; }
        .digit-block:hover { border-color: rgba(255,255,255,0.1); background: rgba(255,255,255,0.04); }
        .digit-block.bottom-row { margin-top: 40px; } 

        .abc-header { display: flex; gap: 8px; margin-bottom: 12px; height: 30px; }
        .abc-item { display: flex; flex-direction: column; align-items: center; font-size: 10px; color: var(--text-muted); font-weight: bold; }
        .abc-item input { width: 20px; height: 16px; border-bottom: 1px solid #475569; }

        /* VISUAL 7 SEGMENTOS (NEON STYLE) */
        .digit-visual { position: relative; width: 70px; height: var(--digit-h); background: transparent; margin-bottom: 10px; }
        .seg { position: absolute; background: var(--seg-off); border-radius: 4px; cursor: pointer; transition: all 0.2s; opacity: 0.4; }
        .seg:hover { opacity: 0.8; }
        
        .seg-h { height: var(--seg-h-thick); left: 14px; right: 14px; }
        .seg-v { width: var(--seg-h-thick); height: 42px; } 
        
        .s-a { top: 0; } .s-g { top: 55px; } .s-d { bottom: 0; }
        .s-f { left: 0; top: 8px; } .s-b { right: 0; top: 8px; }
        .s-e { left: 0; top: 62px; } .s-c { right: 0; top: 62px; }
        
        /* ESTADOS DE LOS SEGMENTOS */
        .st-1 { background: var(--neon-blue) !important; box-shadow: 0 0 15px var(--neon-blue), inset 0 0 5px white; opacity: 1 !important; z-index: 2; }
        .st-off-auto { 
            background: transparent !important; 
            border: 1px solid var(--neon-red); 
            box-shadow: inset 0 0 5px rgba(248, 113, 113, 0.3); 
            background-image: linear-gradient(45deg, transparent 25%, rgba(248,113,113,0.5) 25%, rgba(248,113,113,0.5) 50%, transparent 50%, transparent 75%, rgba(248,113,113,0.5) 75%, rgba(248,113,113,0.5) 100%);
            background-size: 10px 10px;
            opacity: 0.8 !important;
        }

        /* Comparadores */
        .comp { 
            width: 36px; height: 36px; 
            background: #1e293b; border: 2px solid #475569; 
            border-radius: 50%; display: flex; align-items: center; justify-content: center; 
            font-weight: bold; color: var(--text-muted); cursor: pointer; align-self: center; margin-top: 40px; 
            font-family: 'Orbitron', monospace; transition: 0.3s;
        }
        .comp:hover { border-color: var(--neon-orange); color: var(--neon-orange); }
        .rotate-90 { transform: rotate(90deg); }
        .v-comps { grid-column: 2 / 7; display: flex; justify-content: space-around; padding: 20px 0; }
        
        /* Scratch Pad */
        .scratch-pad { display: grid; grid-template-columns: repeat(5, 1fr); gap: 3px; margin-top: 5px; width: 100%; }
        .num-pick { 
            font-size: 10px; height: 20px; 
            background: #334155; color: #fff; border-radius: 3px; 
            cursor: pointer; text-align: center; line-height: 20px; transition: 0.2s; 
        }
        .num-pick:hover { background: #475569; }
        .num-pick.scratched { opacity: 0.3; text-decoration: line-through; background: #0f172a; color: #64748b; }
        
        /* Paridad P/I */
        .parity-container { display: flex; gap: 5px; margin-top: 8px; width: 100%; }
        .p-indicator { 
            flex: 1; font-size: 10px; padding: 4px 0; text-align: center;
            border: 1px solid #475569; border-radius: 4px; cursor: pointer; color: #64748b; transition: 0.3s;
        }
        .p-indicator.active { background: var(--neon-purple); color: #fff; border-color: var(--neon-purple); box-shadow: 0 0 10px var(--neon-purple); font-weight: bold; }

        /* Nombre del jugador input */
        .digit-block > input { width: 100%; font-size: 16px; margin-top: 10px; color: var(--neon-green); }

        /* --- PANEL LATERAL (IA) --- */
        .ai-panel { 
            background: rgba(15, 23, 42, 0.8); 
            backdrop-filter: blur(12px);
            color: #fff; width: 360px; padding: 25px; border-radius: 20px; 
            height: fit-content; position: sticky; top: 20px; 
            border: 1px solid var(--glass-border);
            box-shadow: 0 10px 20px rgba(0,0,0,0.3);
        }
        .ai-panel h3 { color: var(--neon-blue); margin-top: 0; text-align: center; font-size: 16px; text-transform: uppercase; letter-spacing: 1px; font-family: 'Orbitron', sans-serif; border-bottom: 1px solid #334155; padding-bottom: 10px; margin-bottom: 20px; }
        
        .q-box { background: #1e293b; padding: 15px; margin-bottom: 15px; border-radius: 12px; border: 1px solid #334155; position: relative; }
        .q-box label { font-size: 12px; font-weight: bold; display: block; margin-bottom: 10px; color: var(--neon-blue); font-family: 'Orbitron', sans-serif; }
        .q-controls { display: flex; gap: 8px; }
        
        .btn-private { 
            background: linear-gradient(135deg, #7c3aed, #c084fc) !important; 
            color: white !important; width: 40px !important; flex-shrink: 0; 
            border-radius: 8px; display: flex; justify-content: center; align-items: center;
        }
        
        select { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #475569; font-size: 13px; cursor: pointer; transition: 0.3s; }
        select:hover { border-color: var(--neon-blue); }
        
        button { 
            width: 100%; padding: 10px; border-radius: 8px; border: none; font-size: 13px; 
            font-weight: bold; cursor: pointer; margin-top: 5px; text-transform: uppercase; letter-spacing: 0.5px; 
            transition: 0.3s;
        }
        /* Boton Preguntar Gen√©rico */
        .q-box > button { background: #334155; color: #e2e8f0; margin-top: 10px; }
        .q-box > button:hover { background: #475569; color: white; }

        /* --- LOG CONSOLE (Chat Style) --- */
        #log { 
            background: #0f172a; 
            height: 300px; 
            overflow-y: auto; 
            padding: 15px; 
            border-radius: 12px; 
            border: 1px solid #334155; 
            margin-top: 20px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            font-family: 'Roboto Mono', monospace;
            font-size: 12px;
        }
        /* Log bubbles */
        #log div { 
            background: #1e293b; padding: 8px 12px; border-radius: 8px; border-left: 3px solid var(--neon-blue); 
            animation: slideIn 0.3s ease; 
        }
        @keyframes slideIn { from { opacity: 0; transform: translateX(-10px); } to { opacity: 1; transform: translateX(0); } }

        /* SETUP BOX */
        .setup-box { border: 2px dashed #475569; padding: 15px; margin-bottom: 20px; text-align: center; border-radius: 12px; background: rgba(0,0,0,0.2); }
        .setup-inputs { display: flex; gap: 8px; justify-content: center; margin-top: 10px; margin-bottom: 10px; }
        .setup-inputs input { width: 36px; height: 36px; font-size: 18px; border: 1px solid #475569; border-radius: 6px; background: #1e293b; color: white; }

        /* --- OVERLAY --- */
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(10px); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .login-box { 
            background: #1e293b; padding: 40px; border-radius: 24px; color: white; text-align: center; 
            border: 1px solid #334155; width: 320px; box-shadow: 0 20px 50px rgba(0,0,0,0.5); 
        }
        .login-box h2 { font-family: 'Orbitron', sans-serif; color: var(--neon-blue); margin-bottom: 30px; }
        .login-box input { width: 100%; padding: 12px; background: #0f172a; border: 1px solid #334155; border-radius: 8px; color: white; margin-bottom: 15px; text-align: left; }
        
        .solo-btn { background: linear-gradient(135deg, var(--neon-orange), #f59e0b); color: #000; box-shadow: 0 4px 15px rgba(251, 191, 36, 0.3); }
        .solo-btn:hover { filter: brightness(1.1); transform: translateY(-2px); }
        
        .btn-disabled { background: #334155 !important; color: #94a3b8 !important; box-shadow: none !important; cursor: not-allowed !important; opacity: 0.7; }
        
        /* ESTADISTICAS */
        .rank-table { width: 100%; border-collapse: collapse; margin-bottom: 15px; font-size: 12px; margin-top: 10px; }
        .rank-table th, .rank-table td { border: 1px solid #334155; padding: 6px; text-align: left; color: #cbd5e1; }
        .rank-table th { background: #1e293b; color: var(--neon-blue); }
        
        .bar-container { height: 8px; background: #0f172a; width: 100%; margin-top: 4px; border-radius: 4px; overflow: hidden; }
        .bar-fill { height: 100%; background: var(--neon-green); width: 0%; border-radius: 4px; transition: width 0.8s ease; }
        
        .question-counter { font-size: 24px; font-family: 'Orbitron', sans-serif; text-align: center; margin-bottom: 15px; color: var(--neon-blue); text-shadow: 0 0 10px rgba(56, 189, 248, 0.5); }
        
        /* Animaciones Turnos */
        .turn-tag { background: #1e293b; color: var(--text-muted); padding: 10px; border-radius: 8px; margin-bottom: 15px; font-weight: bold; text-align: center; font-size: 14px; border: 1px solid #334155; transition: 0.3s; }
        .turn-tag.active { background: rgba(74, 222, 128, 0.1); color: var(--neon-green); border-color: var(--neon-green); box-shadow: 0 0 15px rgba(74, 222, 128, 0.2); }

        /* AUTO FILL ANIMATION (M√°s Sci-Fi) */
        .auto-fill { 
            color: var(--neon-red) !important; 
            text-shadow: 0 0 8px var(--neon-red);
            border-color: var(--neon-red) !important; 
            animation: pulseRed 1.5s ease; 
        }
        @keyframes pulseRed { 
            0% { box-shadow: 0 0 0 0 rgba(248, 113, 113, 0.7); } 
            70% { box-shadow: 0 0 0 10px rgba(248, 113, 113, 0); } 
            100% { box-shadow: 0 0 0 0 rgba(248, 113, 113, 0); } 
        }

        /* MODAL DE VICTORIA */
        #win-modal { display:none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); backdrop-filter: blur(5px); z-index:2000; align-items:center; justify-content:center; }
        .win-box { 
            background: linear-gradient(135deg, #1e293b, #0f172a); 
            border: 1px solid var(--neon-green); 
            padding: 40px; border-radius: 24px; color: white; text-align: center; max-width: 450px; width: 90%; 
            box-shadow: 0 0 50px rgba(74, 222, 128, 0.3); animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
        }
        @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .win-box h2 { color: var(--neon-green); margin-top:0; font-family: 'Orbitron', sans-serif; font-size: 28px; text-shadow: 0 0 10px rgba(74, 222, 128, 0.5); }
        .win-box p { font-size: 16px; line-height: 1.6; margin: 25px 0; color: #e2e8f0; }
        .win-btns { display:flex; gap:15px; }
        .win-btns button { flex:1; padding:15px; border-radius: 12px; font-size: 14px; transition: 0.3s; }
        .win-btns button:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.3); }

        .hint-step { 
            background: rgba(56, 189, 248, 0.1); 
            border-left: 3px solid var(--neon-blue); 
            border-radius: 4px; padding: 10px; margin-bottom: 6px; font-size: 12px; animation: fadeIn 0.5s; 
        }

        /* --- TUTORIAL --- */
        @keyframes tFadeIn { from { opacity:0; transform:translateX(15px); } to { opacity:1; transform:translateX(0); } }
        .tut-slide { animation: tFadeIn 0.3s ease; }
        .tut-tag { display:inline-block; background:rgba(56,189,248,0.15); border:1px solid rgba(56,189,248,0.3); color:var(--neon-blue); font-size:11px; font-family:'Orbitron',sans-serif; padding:3px 10px; border-radius:20px; margin-bottom:14px; letter-spacing:1px; }
        .tut-tag-orange { background:rgba(251,191,36,0.1); border-color:rgba(251,191,36,0.3); color:var(--neon-orange); }
        .tut-tag-green  { background:rgba(74,222,128,0.1);  border-color:rgba(74,222,128,0.3);  color:var(--neon-green); }
        .tut-tag-purple { background:rgba(192,132,252,0.1); border-color:rgba(192,132,252,0.3); color:var(--neon-purple); }
        .tut-h2 { font-family:'Orbitron',sans-serif; font-size:20px; margin-bottom:12px; background:linear-gradient(90deg,var(--neon-blue),var(--neon-purple)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
        .tut-p  { font-size:14px; line-height:1.7; color:#cbd5e1; margin-bottom:10px; }
        .tut-strong { color:var(--neon-orange); -webkit-text-fill-color:var(--neon-orange); }
        .tut-seg-row { display:flex; gap:16px; margin:14px 0; justify-content:center; flex-wrap:wrap; align-items:flex-end; }
        .tut-dw  { display:flex; flex-direction:column; align-items:center; gap:6px; }
        .tut-lbl { font-family:'Orbitron',sans-serif; font-size:10px; color:var(--text-muted); letter-spacing:1px; }
        .tut-val { font-family:'Orbitron',sans-serif; font-size:12px; color:var(--neon-blue); font-weight:700; }
        .tut-seg-d { position:relative; width:44px; height:76px; }
        .ts { position:absolute; border-radius:3px; transition:all 0.3s; }
        .ts.h { height:7px; left:9px; right:9px; }
        .ts.v { width:7px; height:27px; }
        .ts.on  { background:var(--neon-blue); box-shadow:0 0 10px var(--neon-blue); opacity:1; }
        .ts.off { background:#1e3a4a; opacity:0.25; }
        .sa { top:0; } .sb { right:0; top:5px; } .sc { right:0; top:44px; }
        .sd { bottom:0; } .se { left:0; top:44px; } .sf { left:0; top:5px; } .sg { top:37px; }
        .tut-answer-box { background:rgba(74,222,128,0.08); border:1px solid rgba(74,222,128,0.3); border-radius:10px; padding:12px 16px; margin-top:10px; font-size:13px; display:flex; align-items:center; gap:10px; }
        .tut-answer-blue   { background:rgba(56,189,248,0.08);  border-color:rgba(56,189,248,0.3); }
        .tut-answer-purple { background:rgba(192,132,252,0.08); border-color:rgba(192,132,252,0.3); }
        .tut-node { width:40px; height:40px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-family:'Orbitron',sans-serif; font-size:14px; font-weight:900; border:2px solid; }
        .tut-rank-row { display:flex; align-items:center; gap:12px; background:rgba(255,255,255,0.03); border:1px solid var(--glass-border); border-radius:8px; padding:8px 14px; }
        .tut-nav-btn { background:transparent; border:1px solid #475569; color:var(--text-main); padding:10px 24px; border-radius:8px; font-family:'Orbitron',sans-serif; font-size:11px; letter-spacing:1px; cursor:pointer; transition:all 0.2s; }
        .tut-nav-btn:hover:not(:disabled) { border-color:var(--neon-blue); color:var(--neon-blue); }
        .tut-nav-btn:disabled { opacity:0.3; cursor:not-allowed; }
        .tut-nav-primary { background:linear-gradient(135deg,var(--neon-blue),#6366f1); border-color:transparent; color:white; box-shadow:0 0 15px rgba(56,189,248,0.3); }
        .tut-nav-primary:hover:not(:disabled) { filter:brightness(1.15); transform:translateY(-1px); border-color:transparent; color:white; }
        .tut-dot { width:8px; height:8px; border-radius:50%; background:#334155; cursor:pointer; transition:all 0.2s; }
        .tut-dot.active { background:var(--neon-blue); box-shadow:0 0 6px var(--neon-blue); width:20px; border-radius:4px; }

        /* --- SCANLINES + CRT --- */
        .scanlines-layer {
            position: fixed; inset: 0; pointer-events: none; z-index: 999;
            background: repeating-linear-gradient(
                to bottom,
                transparent 0px, transparent 2px,
                rgba(0,0,0,0.18) 2px, rgba(0,0,0,0.18) 4px
            );
        }
        .scanlines-layer::before {
            content: '';
            position: fixed; left: 0; right: 0; height: 80px; top: -80px;
            background: linear-gradient(
                to bottom,
                transparent 0%,
                rgba(56,189,248,0.07) 40%,
                rgba(56,189,248,0.13) 50%,
                rgba(56,189,248,0.07) 60%,
                transparent 100%
            );
            animation: scanSweep 3s linear infinite;
        }
        @keyframes scanSweep {
            0%   { top: -80px; }
            100% { top: 100vh; }
        }
        .scanlines-layer::after {
            content: '';
            position: fixed; inset: 0;
            background: repeating-linear-gradient(
                to bottom,
                rgba(56,189,248,0.02) 0px, rgba(56,189,248,0.02) 1px,
                transparent 1px, transparent 8px
            );
            animation: matrixLines 10s linear infinite;
        }
        @keyframes matrixLines {
            from { background-position: 0 0; }
            to   { background-position: 0 -200px; }
        }
        .crt-vignette {
            position: fixed; inset: 0; pointer-events: none; z-index: 999;
            background: radial-gradient(ellipse at center, transparent 55%, rgba(0,0,0,0.6) 100%);
        }

        /* --- GLITCH T√çTULO LOGIN --- */
        .glitch-title {
            position: relative;
            display: inline-block;
            animation: glitchMain 1.5s infinite;
        }
        .glitch-title::before,
        .glitch-title::after {
            content: attr(data-text);
            position: absolute;
            top: 0; left: 0;
            width: 100%;
            font-family: inherit; font-size: inherit; font-weight: inherit;
            color: var(--neon-blue);
        }
        .glitch-title::before {
            color: var(--neon-red);
            clip-path: polygon(0 0, 100% 0, 100% 35%, 0 35%);
            animation: glitchTop 1.5s infinite;
            opacity: 0;
        }
        .glitch-title::after {
            color: var(--neon-green);
            clip-path: polygon(0 65%, 100% 65%, 100% 100%, 0 100%);
            animation: glitchBot 1.5s infinite;
            opacity: 0;
        }
        @keyframes glitchMain {
            0%, 70%, 100% { transform: none; filter: none; }
            72%  { transform: skewX(-1.5deg); }
            74%  { transform: skewX(1.5deg) skewY(0.4deg); filter: blur(0.5px); }
            76%  { transform: skewX(-0.5deg); }
            78%  { transform: none; }
            82%  { transform: skewX(2.5deg); filter: blur(0.3px); }
            84%  { transform: none; }
        }
        @keyframes glitchTop {
            0%, 69%, 100% { opacity: 0; transform: none; }
            71% { opacity: 1; transform: translate(-4px, -2px); }
            73% { opacity: 1; transform: translate(3px, 0); }
            75% { opacity: 1; transform: translate(-2px, -1px); }
            77% { opacity: 0; }
            81% { opacity: 0.9; transform: translate(5px, 0); }
            83% { opacity: 0; }
        }
        @keyframes glitchBot {
            0%, 69%, 100% { opacity: 0; transform: none; }
            71% { opacity: 1; transform: translate(4px, 2px); }
            73% { opacity: 1; transform: translate(-3px, 0); }
            75% { opacity: 1; transform: translate(2px, 1px); }
            77% { opacity: 0; }
            81% { opacity: 0.9; transform: translate(-5px, 0); }
            83% { opacity: 0; }
        }

        /* --- CONTADOR TURNOS PROGRESIVO --- */
        .question-counter { transition: color 0.5s ease, text-shadow 0.5s ease; }
        .question-counter.turn-safe   { color: var(--neon-green);  text-shadow: 0 0 12px rgba(74,222,128,0.5); }
        .question-counter.turn-warn   { color: var(--neon-orange); text-shadow: 0 0 12px rgba(251,191,36,0.5); }
        .question-counter.turn-danger {
            color: var(--neon-red);
            text-shadow: 0 0 15px rgba(248,113,113,0.7);
            animation: pulseTurnDanger 1s ease-in-out infinite;
        }
        @keyframes pulseTurnDanger {
            0%, 100% { text-shadow: 0 0 8px rgba(248,113,113,0.5); }
            50%       { text-shadow: 0 0 25px rgba(248,113,113,0.9), 0 0 50px rgba(248,113,113,0.3); }
        }

        /* --- RANKING DIARIO --- */
        #daily-ranking { display:none; margin-top:16px; border-top:1px solid #334155; padding-top:14px; }
        #daily-ranking h4 { font-family:'Orbitron',sans-serif; font-size:11px; letter-spacing:2px; color:var(--neon-blue); margin-bottom:10px; text-align:center; }
        .rank-list { max-height:180px; overflow-y:auto; display:flex; flex-direction:column; gap:4px; margin-bottom:10px; }
        .rank-list-row { display:flex; align-items:center; gap:10px; padding:6px 10px; border-radius:6px; font-size:12px; background:rgba(255,255,255,0.03); border:1px solid transparent; }
        .rank-list-row.me { background:rgba(56,189,248,0.1); border-color:rgba(56,189,248,0.3); }
        .rank-list-row .pos { font-family:'Orbitron',sans-serif; font-size:11px; color:var(--text-muted); width:24px; text-align:center; }
        .rank-list-row .pos.gold   { color:#fbbf24; }
        .rank-list-row .pos.silver { color:#94a3b8; }
        .rank-list-row .pos.bronze { color:#b45309; }
        .rank-list-row .rname { flex:1; color:var(--text-main); font-weight:500; }
        .rank-list-row .rname.me { color:var(--neon-blue); font-weight:700; }
        .rank-list-row .rturns { font-family:'Orbitron',sans-serif; font-size:10px; color:var(--text-muted); }
        .rank-list-row .rrank  { font-size:11px; }
        .rank-total { font-size:11px; color:var(--text-muted); text-align:center; font-family:'Orbitron',sans-serif; letter-spacing:1px; }
        .my-position-badge { background:rgba(56,189,248,0.1); border:1px solid rgba(56,189,248,0.3); border-radius:8px; padding:8px 14px; text-align:center; margin-bottom:10px; font-family:'Orbitron',sans-serif; font-size:12px; color:var(--neon-blue); }
    </style>
</head>
<body>

<div id="win-modal">
    <div class="win-box">
        <h2 id="win-title">üéâ ¬°VICTORIA! üéâ</h2>
        <p id="win-text"></p>
        <div id="daily-ranking">
            <h4>üìä CLASIFICACI√ìN DEL D√çA</h4>
            <div id="my-position-badge" class="my-position-badge"></div>
            <div class="rank-list" id="rank-list"></div>
            <div class="rank-total" id="rank-total"></div>
        </div>
        <div class="win-btns">
            <button onclick="copyToClipboard()" style="background:#2563eb; color:white;">üìã COPIAR</button>
            <button onclick="document.getElementById('win-modal').style.display='none'" style="background:#334155; color:white;">CERRAR</button>
        </div>
    </div>
</div>

<div id="login-screen" class="overlay" style="position:fixed; overflow:hidden;">
    <div class="scanlines-layer"></div>
    <div class="crt-vignette"></div>
    <div class="login-box">
        <h2 class="glitch-title" data-text="HIDE CODE">HIDE CODE</h2>
        <input type="text" id="p-name" placeholder="Tu Nombre">
        <div style="display:flex; gap:10px; align-items:center;">
            <input type="text" id="p-room" placeholder="C√≥d. Sala" style="margin-bottom:0">
            <button onclick="connectMulti()" style="width:auto; padding:12px; background:var(--neon-blue); color:#000;">ENTRAR</button>
        </div>
        <div style="height:20px; border-bottom:1px solid #334155; margin: 20px 0;"></div>
        <button onclick="initSolitaireMenu()" class="solo-btn">PARTIDA EN SOLITARIO</button>
        <button onclick="openTutorial()" style="background:transparent; border:1px solid #475569; color:var(--text-muted); margin-top:10px;">üìñ TUTORIAL</button>
    </div>
</div>


<!-- MODAL TUTORIAL -->
<div id="tutorial-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(15,23,42,0.97); backdrop-filter:blur(10px); z-index:2000; align-items:center; justify-content:center; padding:20px;">
    <div style="background:rgba(15,23,42,0.99); border:1px solid var(--glass-border); border-radius:24px; width:100%; max-width:620px; box-shadow:0 25px 60px rgba(0,0,0,0.6); overflow:hidden; position:relative; max-height:90vh; overflow-y:auto;">
        <div style="background:linear-gradient(135deg,rgba(56,189,248,0.1),rgba(192,132,252,0.1)); border-bottom:1px solid var(--glass-border); padding:20px 30px; display:flex; align-items:center; justify-content:space-between; position:sticky; top:0; z-index:1; backdrop-filter:blur(10px);">
            <div style="font-family:'Orbitron',sans-serif; font-size:14px; letter-spacing:3px; color:var(--neon-blue);">TUTORIAL</div>
            <div style="font-family:'Orbitron',sans-serif; font-size:12px; color:var(--text-muted);">Paso <span id="tut-cur">1</span> de 7</div>
        </div>
        <div style="height:3px; background:rgba(255,255,255,0.05);"><div id="tut-progress" style="height:100%; background:linear-gradient(90deg,var(--neon-blue),var(--neon-purple)); width:16.6%; transition:width 0.4s ease; box-shadow:0 0 8px var(--neon-blue);"></div></div>

        <!-- SLIDE 1 -->
        <div class="tut-slide" id="tslide-0" style="padding:35px 40px; display:flex; flex-direction:column; justify-content:center;">
            <div style="font-size:40px; margin-bottom:16px;">üïµÔ∏è</div>
            <div class="tut-tag">INTRODUCCI√ìN</div>
            <h2 class="tut-h2">¬øQu√© es Hide Code?</h2>
            <p class="tut-p">Hide Code es un juego de <span class="tut-strong">deducci√≥n l√≥gica</span>. Hay un c√≥digo secreto de <span class="tut-strong">6 d√≠gitos</span> (del 0 al 9) oculto, y tu misi√≥n es descifrarlo.</p>
            <p class="tut-p">Los d√≠gitos no se muestran directamente ‚Äî est√°n representados como <span class="tut-strong">displays de 7 segmentos</span>, igual que en una calculadora antigua. T√∫ deduces el c√≥digo haciendo preguntas inteligentes.</p>
            <div class="tut-seg-row">
                <div class="tut-dw"><div class="tut-lbl">T</div><div class="tut-seg-d"><div class="ts h sa on"></div><div class="ts v sb on"></div><div class="ts v sc on"></div><div class="ts h sd on"></div><div class="ts v se off"></div><div class="ts v sf on"></div><div class="ts h sg on"></div></div><div class="tut-val">?</div></div>
                <div class="tut-dw"><div class="tut-lbl">U</div><div class="tut-seg-d"><div class="ts h sa off"></div><div class="ts v sb on"></div><div class="ts v sc on"></div><div class="ts h sd off"></div><div class="ts v se off"></div><div class="ts v sf off"></div><div class="ts h sg off"></div></div><div class="tut-val">?</div></div>
                <div class="tut-dw"><div class="tut-lbl">V</div><div class="tut-seg-d"><div class="ts h sa on"></div><div class="ts v sb on"></div><div class="ts v sc off"></div><div class="ts h sd on"></div><div class="ts v se on"></div><div class="ts v sf off"></div><div class="ts h sg on"></div></div><div class="tut-val">?</div></div>
                <div class="tut-dw"><div class="tut-lbl">W</div><div class="tut-seg-d"><div class="ts h sa on"></div><div class="ts v sb on"></div><div class="ts v sc on"></div><div class="ts h sd on"></div><div class="ts v se off"></div><div class="ts v sf off"></div><div class="ts h sg on"></div></div><div class="tut-val">?</div></div>
                <div class="tut-dw"><div class="tut-lbl">X</div><div class="tut-seg-d"><div class="ts h sa on"></div><div class="ts v sb off"></div><div class="ts v sc on"></div><div class="ts h sd on"></div><div class="ts v se on"></div><div class="ts v sf on"></div><div class="ts h sg on"></div></div><div class="tut-val">?</div></div>
                <div class="tut-dw"><div class="tut-lbl">Y</div><div class="tut-seg-d"><div class="ts h sa on"></div><div class="ts v sb on"></div><div class="ts v sc on"></div><div class="ts h sd on"></div><div class="ts v se off"></div><div class="ts v sf on"></div><div class="ts h sg on"></div></div><div class="tut-val">?</div></div>
            </div>
            <p class="tut-p">Los 6 d√≠gitos se llaman <span class="tut-strong">T, U, V, W, X, Y</span>. Regla clave: <span class="tut-strong">dos d√≠gitos adyacentes no pueden ser iguales</span>.</p>
        </div>

        <!-- SLIDE 2 -->
        <div class="tut-slide" id="tslide-1" style="padding:35px 40px; display:none; flex-direction:column; justify-content:center;">
            <div class="tut-tag">LOS DISPLAYS</div>
            <h2 class="tut-h2">Displays de 7 Segmentos</h2>
            <p class="tut-p">Cada d√≠gito del 0 al 9 enciende una combinaci√≥n distinta de 7 segmentos. Los segmentos se organizan en <span class="tut-strong">columnas (A‚ÄìI)</span> y <span class="tut-strong">filas (J‚ÄìS)</span>.</p>
            <div class="tut-seg-row" style="justify-content:center; gap:30px; margin:16px 0;">
                <div class="tut-dw"><div class="tut-lbl">EJEMPLO: 9</div><div class="tut-seg-d" style="transform:scale(1.3); margin:10px 0 20px;"><div class="ts h sa" style="background:var(--neon-green); box-shadow:0 0 10px var(--neon-green); opacity:1;"></div><div class="ts v sb" style="background:var(--neon-green); box-shadow:0 0 10px var(--neon-green); opacity:1;"></div><div class="ts v sc" style="background:var(--neon-green); box-shadow:0 0 10px var(--neon-green); opacity:1;"></div><div class="ts h sd" style="background:var(--neon-green); box-shadow:0 0 10px var(--neon-green); opacity:1;"></div><div class="ts v se off"></div><div class="ts v sf" style="background:var(--neon-green); box-shadow:0 0 10px var(--neon-green); opacity:1;"></div><div class="ts h sg" style="background:var(--neon-green); box-shadow:0 0 10px var(--neon-green); opacity:1;"></div></div><div class="tut-val" style="color:var(--neon-green)">6 segmentos</div></div>
                <div class="tut-dw"><div class="tut-lbl">EJEMPLO: 1</div><div class="tut-seg-d" style="transform:scale(1.3); margin:10px 0 20px;"><div class="ts h sa off"></div><div class="ts v sb" style="background:var(--neon-red); box-shadow:0 0 10px var(--neon-red); opacity:1;"></div><div class="ts v sc" style="background:var(--neon-red); box-shadow:0 0 10px var(--neon-red); opacity:1;"></div><div class="ts h sd off"></div><div class="ts v se off"></div><div class="ts v sf off"></div><div class="ts h sg off"></div></div><div class="tut-val" style="color:var(--neon-red)">2 segmentos</div></div>
                <div class="tut-dw"><div class="tut-lbl">EJEMPLO: 8</div><div class="tut-seg-d" style="transform:scale(1.3); margin:10px 0 20px;"><div class="ts h sa" style="background:var(--neon-purple); box-shadow:0 0 10px var(--neon-purple); opacity:1;"></div><div class="ts v sb" style="background:var(--neon-purple); box-shadow:0 0 10px var(--neon-purple); opacity:1;"></div><div class="ts v sc" style="background:var(--neon-purple); box-shadow:0 0 10px var(--neon-purple); opacity:1;"></div><div class="ts h sd" style="background:var(--neon-purple); box-shadow:0 0 10px var(--neon-purple); opacity:1;"></div><div class="ts v se" style="background:var(--neon-purple); box-shadow:0 0 10px var(--neon-purple); opacity:1;"></div><div class="ts v sf" style="background:var(--neon-purple); box-shadow:0 0 10px var(--neon-purple); opacity:1;"></div><div class="ts h sg" style="background:var(--neon-purple); box-shadow:0 0 10px var(--neon-purple); opacity:1;"></div></div><div class="tut-val" style="color:var(--neon-purple)">7 segmentos</div></div>
            </div>
            <p class="tut-p">F√≠jate en la <span class="tut-strong">barra de referencia</span> en la parte superior del juego: muestra c√≥mo se ve cada n√∫mero del 0 al 9. ¬°√ösala siempre!</p>
        </div>

        <!-- SLIDE 3 -->
        <div class="tut-slide" id="tslide-2" style="padding:35px 40px; display:none; flex-direction:column; justify-content:center;">
            <div class="tut-tag tut-tag-orange">PREGUNTA TIPO 1</div>
            <h2 class="tut-h2">Q1 ‚Äî Suma de Segmentos</h2>
            <p class="tut-p">Preguntas por una <span class="tut-strong">columna</span> o <span class="tut-strong">fila</span> del tablero. El juego cuenta cu√°ntos segmentos est√°n encendidos en esa zona y te da el total.</p>
            <p class="tut-p">Ejemplo: la <span class="tut-strong">fila K</span> corresponde a los segmentos laterales superiores de los 3 primeros d√≠gitos (T, U, V):</p>
            <div class="tut-seg-row" style="gap:10px; align-items:flex-end;">
                <div class="tut-dw"><div class="tut-lbl">T = 9</div><div class="tut-seg-d"><div class="ts h sa on" style="opacity:0.2;"></div><div class="ts v sb" style="background:var(--neon-orange); box-shadow:0 0 14px var(--neon-orange); opacity:1;"></div><div class="ts v sc on" style="opacity:0.2;"></div><div class="ts h sd on" style="opacity:0.2;"></div><div class="ts v se off"></div><div class="ts v sf" style="background:var(--neon-orange); box-shadow:0 0 14px var(--neon-orange); opacity:1;"></div><div class="ts h sg on" style="opacity:0.2;"></div></div><div class="tut-val" style="color:var(--neon-orange); font-size:10px;">fila K: ‚úì‚úì</div></div>
                <div class="tut-dw"><div class="tut-lbl">U = 1</div><div class="tut-seg-d"><div class="ts h sa off"></div><div class="ts v sb" style="background:var(--neon-orange); box-shadow:0 0 14px var(--neon-orange); opacity:1;"></div><div class="ts v sc on" style="opacity:0.2;"></div><div class="ts h sd off"></div><div class="ts v se off"></div><div class="ts v sf" style="border:1.5px dashed var(--neon-red); background:transparent; opacity:0.6;"></div><div class="ts h sg off"></div></div><div class="tut-val" style="color:var(--neon-orange); font-size:10px;">fila K: ‚úì‚úó</div></div>
                <div class="tut-dw"><div class="tut-lbl">V = 5</div><div class="tut-seg-d"><div class="ts h sa on" style="opacity:0.2;"></div><div class="ts v sb" style="border:1.5px dashed var(--neon-red); background:transparent; opacity:0.6;"></div><div class="ts v sc on" style="opacity:0.2;"></div><div class="ts h sd on" style="opacity:0.2;"></div><div class="ts v se off"></div><div class="ts v sf" style="background:var(--neon-orange); box-shadow:0 0 14px var(--neon-orange); opacity:1;"></div><div class="ts h sg on" style="opacity:0.2;"></div></div><div class="tut-val" style="color:var(--neon-orange); font-size:10px;">fila K: ‚úó‚úì</div></div>
                <div style="font-size:28px; color:var(--text-muted); padding-bottom:30px;">=</div>
                <div class="tut-dw"><div class="tut-lbl" style="color:var(--neon-orange); font-weight:bold;">TOTAL</div><div style="font-family:'Orbitron',sans-serif; font-size:48px; font-weight:900; color:var(--neon-orange); text-shadow:0 0 20px var(--neon-orange); line-height:1; margin:8px 0;">4</div><div class="tut-val" style="color:var(--neon-orange); font-size:10px;">segmentos</div></div>
            </div>
            <div class="tut-answer-box"><div style="font-size:20px;">üí¨</div><div><strong style="color:var(--neon-green); font-family:'Orbitron',sans-serif; font-size:12px;">PREGUNTA:</strong> "Fila K"<br><strong style="color:var(--neon-orange);">RESPUESTA: 4</strong> ‚Äî Hay 4 segmentos encendidos en esa fila.</div></div>
        </div>

        <!-- SLIDE 4 -->
        <div class="tut-slide" id="tslide-3" style="padding:35px 40px; display:none; flex-direction:column; justify-content:center;">
            <div class="tut-tag tut-tag-green">PREGUNTAS TIPO 2 Y 3</div>
            <h2 class="tut-h2">Q2 ‚Äî Paridad &nbsp;¬∑&nbsp; Q3 ‚Äî Comparar</h2>
            <p class="tut-p"><span class="tut-strong">Q2 Paridad:</span> seleccionas un d√≠gito y el juego te dice si su valor es <span class="tut-strong">PAR o IMPAR</span>.</p>
            <div class="tut-answer-box tut-answer-blue" style="margin-bottom:14px;"><div style="font-size:20px;">üí¨</div><div><strong style="color:var(--neon-blue); font-family:'Orbitron',sans-serif; font-size:12px;">PREGUNTA:</strong> "¬øT es par o impar?"<br><strong style="color:var(--neon-blue);">RESPUESTA: PAR</strong> ‚Äî T es 0, 2, 4, 6 u 8.</div></div>
            <p class="tut-p"><span class="tut-strong">Q3 Comparar:</span> seleccionas dos d√≠gitos <span class="tut-strong">adyacentes</span> y el juego te dice cu√°l es mayor, menor o si son iguales.</p>
            <div style="display:flex; gap:8px; align-items:center; justify-content:center; margin:12px 0; flex-wrap:wrap;">
                <div class="tut-node" style="border-color:var(--neon-blue); color:var(--neon-blue); background:rgba(56,189,248,0.1);">T</div>
                <div style="color:var(--text-muted); font-size:12px;">‚Üî</div>
                <div class="tut-node" style="border-color:var(--neon-green); color:var(--neon-green); background:rgba(74,222,128,0.1);">U</div>
                <div style="color:var(--text-muted); font-size:12px;">‚Üî</div>
                <div class="tut-node" style="border-color:var(--neon-purple); color:var(--neon-purple); background:rgba(192,132,252,0.1);">V</div>
            </div>
            <div class="tut-answer-box"><div style="font-size:20px;">üí¨</div><div><strong style="color:var(--neon-green); font-family:'Orbitron',sans-serif; font-size:12px;">PREGUNTA:</strong> "¬øT vs U?"<br><strong style="color:var(--neon-green);">RESPUESTA: T &gt; U</strong> ‚Äî El valor de T es mayor que el de U.</div></div>
        </div>

        <!-- SLIDE 5 -->
        <div class="tut-slide" id="tslide-4" style="padding:35px 40px; display:none; flex-direction:column; justify-content:center;">
            <div class="tut-tag tut-tag-purple">PREGUNTA TIPO 4</div>
            <h2 class="tut-h2">Q4 ‚Äî Coordenada Exacta</h2>
            <p class="tut-p">La pregunta m√°s precisa: seleccionas una <span class="tut-strong">coordenada exacta</span> (columna + fila) y el juego te dice si ese segmento espec√≠fico est√° <span class="tut-strong">ENCENDIDO o APAGADO</span>.</p>
            <div class="tut-seg-row" style="justify-content:center;">
                <div class="tut-dw"><div class="tut-lbl">D√çGITO T</div><div class="tut-seg-d" style="transform:scale(1.4); margin:14px 0 22px;"><div class="ts h sa on" style="opacity:0.25;"></div><div class="ts v sb on" style="opacity:0.25;"></div><div class="ts v sc on" style="opacity:0.25;"></div><div class="ts h sd on" style="opacity:0.25;"></div><div class="ts v se off"></div><div class="ts v sf on" style="opacity:0.25;"></div><div class="ts h sg" style="background:var(--neon-purple); box-shadow:0 0 20px var(--neon-purple), inset 0 0 6px white; opacity:1;"></div></div><div class="tut-val" style="color:var(--neon-purple);">Segmento central (L)</div></div>
            </div>
            <div class="tut-answer-box tut-answer-purple"><div style="font-size:20px;">üí¨</div><div><strong style="color:var(--neon-purple); font-family:'Orbitron',sans-serif; font-size:12px;">PREGUNTA:</strong> "¬øCoordenada B-L?"<br><strong style="color:var(--neon-purple);">RESPUESTA: ENCENDIDO</strong> ‚Äî El segmento central del d√≠gito T est√° encendido.</div></div>
            <p class="tut-p" style="margin-top:12px; color:var(--text-muted);">‚ö†Ô∏è No todas las coordenadas son v√°lidas. Si eliges una inexistente, el sistema avisa sin gastar turno.</p>
        </div>

        <!-- SLIDE 6 -->
        <!-- SLIDE 6: MODOS DE JUEGO -->
        <div class="tut-slide" id="tslide-5" style="padding:35px 40px; display:none; flex-direction:column; justify-content:center;">
            <div style="font-size:40px; margin-bottom:16px;">üéÆ</div>
            <div class="tut-tag tut-tag-purple">MODOS DE JUEGO</div>
            <h2 class="tut-h2">¬øC√≥mo quieres jugar?</h2>
            <div style="display:flex; flex-direction:column; gap:10px; margin:8px 0;">
                <div class="tut-rank-row" style="border-color:rgba(251,191,36,0.4); flex-direction:column; align-items:flex-start; gap:4px; padding:12px 14px;">
                    <div style="display:flex; align-items:center; gap:8px; margin-bottom:2px;">
                        <span style="font-size:18px;">üìÖ</span>
                        <span style="font-family:'Orbitron',sans-serif; font-size:12px; font-weight:700; color:var(--neon-orange);">C√ìDIGO DIARIO</span>
                    </div>
                    <p class="tut-p" style="margin:0; font-size:12px;">Un c√≥digo nuevo cada d√≠a, igual para todos los jugadores del mundo. Solo puedes jugarlo <span class="tut-strong">una vez</span>. Al terminar ves tu posici√≥n en el <span class="tut-strong">ranking global del d√≠a</span>.</p>
                </div>
                <div class="tut-rank-row" style="border-color:rgba(56,189,248,0.4); flex-direction:column; align-items:flex-start; gap:4px; padding:12px 14px;">
                    <div style="display:flex; align-items:center; gap:8px; margin-bottom:2px;">
                        <span style="font-size:18px;">üé≤</span>
                        <span style="font-family:'Orbitron',sans-serif; font-size:12px; font-weight:700; color:var(--neon-blue);">SOLITARIO ALEATORIO</span>
                    </div>
                    <p class="tut-p" style="margin:0; font-size:12px;">C√≥digo aleatorio cada partida. Puedes jugar <span class="tut-strong">tantas veces como quieras</span>. Ideal para practicar y mejorar tu t√©cnica.</p>
                </div>
                <div class="tut-rank-row" style="border-color:rgba(74,222,128,0.4); flex-direction:column; align-items:flex-start; gap:4px; padding:12px 14px;">
                    <div style="display:flex; align-items:center; gap:8px; margin-bottom:2px;">
                        <span style="font-size:18px;">üë•</span>
                        <span style="font-family:'Orbitron',sans-serif; font-size:12px; font-weight:700; color:var(--neon-green);">MULTIJUGADOR</span>
                    </div>
                    <p class="tut-p" style="margin:0; font-size:12px;">Varios jugadores en una misma sala descifran <span class="tut-strong">el mismo c√≥digo</span>. Veis las preguntas de todos en tiempo real. Cada jugador tiene adem√°s <span class="tut-strong">1 pregunta privada</span> por partida que solo √©l ve. Se juega por turnos.</p>
                </div>
            </div>
        </div>

        <div class="tut-slide" id="tslide-6" style="padding:35px 40px; display:none; flex-direction:column; justify-content:center;">
            <div style="font-size:40px; margin-bottom:16px;">üèÜ</div>
            <div class="tut-tag tut-tag-green">MODOS Y RANGOS</div>
            <h2 class="tut-h2">¬°A jugar!</h2>
            <p class="tut-p">Tienes <span class="tut-strong">25 turnos m√°ximo</span> y <span class="tut-strong">2 intentos</span> para resolver el c√≥digo. Cuantos menos turnos uses, mejor tu rango:</p>
            <div style="display:flex; flex-direction:column; gap:6px; margin:12px 0;">
                <div class="tut-rank-row" style="border-color:rgba(251,191,36,0.4);"><span style="font-size:16px;">üéñÔ∏è</span><span style="flex:1; font-size:13px; font-weight:600; color:var(--neon-orange);">Master Hacker</span><span style="font-family:'Orbitron',sans-serif; font-size:10px; color:var(--text-muted);">M√≠nimo te√≥rico</span></div>
                <div class="tut-rank-row" style="border-color:rgba(56,189,248,0.4);"><span style="font-size:16px;">üïµÔ∏è</span><span style="flex:1; font-size:13px; font-weight:600; color:var(--neon-blue);">Cript√≥grafo</span><span style="font-family:'Orbitron',sans-serif; font-size:10px; color:var(--text-muted);">+1 a +4</span></div>
                <div class="tut-rank-row" style="border-color:rgba(74,222,128,0.4);"><span style="font-size:16px;">üìä</span><span style="flex:1; font-size:13px; font-weight:600; color:var(--neon-green);">Analista</span><span style="font-family:'Orbitron',sans-serif; font-size:10px; color:var(--text-muted);">+5 a +8</span></div>
                <div class="tut-rank-row" style="border-color:rgba(192,132,252,0.3);"><span style="font-size:16px;">üìö</span><span style="flex:1; font-size:13px; font-weight:600; color:var(--neon-purple);">Aprendiz</span><span style="font-family:'Orbitron',sans-serif; font-size:10px; color:var(--text-muted);">+9 a +12</span></div>
                <div class="tut-rank-row" style="border-color:rgba(148,163,184,0.2);"><span style="font-size:16px;">üå±</span><span style="flex:1; font-size:13px; font-weight:600; color:var(--text-muted);">Novato</span><span style="font-family:'Orbitron',sans-serif; font-size:10px; color:var(--text-muted);">+13 en adelante</span></div>
            </div>
            <p class="tut-p">El <span class="tut-strong">C√≥digo Diario</span> ajusta los rangos al m√≠nimo te√≥rico calculado para ese c√≥digo. ¬°Puedes pedir pistas si te atascas!</p>
        </div>

        <!-- Nav -->
        <div style="padding:20px 40px; border-top:1px solid var(--glass-border); display:flex; justify-content:space-between; align-items:center; background:rgba(0,0,0,0.2); position:sticky; bottom:0; backdrop-filter:blur(10px);">
            <button id="tut-prev" onclick="tutChange(-1)" class="tut-nav-btn" disabled>‚Üê ATR√ÅS</button>
            <div id="tut-dots" style="display:flex; gap:8px;"></div>
            <button id="tut-next" onclick="tutChange(1)" class="tut-nav-btn tut-nav-primary">SIGUIENTE ‚Üí</button>
        </div>
    </div>
</div>
<div class="mode-selector">
    Dise√±o: 
    <select onchange="document.getElementById('w').className = 'wrapper ' + this.value">
        <option value="">Horizontal (Derecha)</option>
        <option value="vertical">Vertical (Abajo)</option>
    </select>
</div>

<div class="digit-reference" id="ref-bar"></div>

<div class="wrapper" id="w">
    <div class="sheet" id="sheet-bg">
        <div class="header-title">HIDE CODE</div>
        
        <div class="tools-bar">
            <button class="tool-btn" id="btn-undo" onclick="execUndo()" title="Deshacer" disabled>
                <svg viewBox="0 0 24 24"><path d="M12.5 8c-2.65 0-5.05.99-6.9 2.6L2 7v9h9l-3.62-3.62c1.39-1.16 3.16-1.88 5.12-1.88 3.54 0 6.55 2.31 7.6 5.5l2.37-.78C21.08 11.03 17.15 8 12.5 8z"/></svg>
            </button>
            <button class="tool-btn" id="btn-redo" onclick="execRedo()" title="Rehacer" disabled>
                <svg viewBox="0 0 24 24"><path d="M18.4 10.6C16.55 9 14.15 8 11.5 8c-4.65 0-8.58 3.03-9.96 7.22L3.9 16c1.05-3.19 4.05-5.5 7.6-5.5 1.95 0 3.73.72 5.12 1.88L13 16h9V7l-3.6 3.6z"/></svg>
            </button>
            <div style="width:1px; background:#475569; margin:0 5px;"></div>
            <button class="tool-btn btn-clear" onclick="execClear()" title="Limpiar Hoja">
                <svg viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
            </button>
        </div>

        <div class="game-grid" id="main-grid"></div>
    </div>

    <div class="ai-panel">
        <h3 id="panel-title">CONFIGURACI√ìN</h3>
        
        <div id="multi-setup" style="display:none;">
            <div class="setup-box" id="setup-area">
                <label>C√≥digo Secreto:</label>
                <div class="setup-inputs">
                    <input type="text" id="s-0" maxlength="1"><input type="text" id="s-1" maxlength="1"><input type="text" id="s-2" maxlength="1"><input type="text" id="s-3" maxlength="1"><input type="text" id="s-4" maxlength="1"><input type="text" id="s-5" maxlength="1">
                </div>
                <button onclick="setManualCode()" style="background: var(--neon-orange); color:black;">Fijar C√≥digo</button>
                <button onclick="setRandomCode()" style="background: var(--neon-green); color:black;">Generar Aleatorio</button>
            </div>
            <div id="turn-display" class="turn-tag">Conectando...</div>
            <div id="player-list-box"></div>
        </div>

        <div id="solo-panel" style="display:none;">
            <div id="solo-controls">
                <button id="btn-solo-rand" onclick="startSolitaire('random')" style="background: linear-gradient(135deg, #10b981, #059669); margin-bottom:8px;">Jugar Aleatorio (‚àû)</button>
                <button id="btn-solo-daily" onclick="startSolitaire('daily')" style="background: linear-gradient(135deg, #f59e0b, #d97706); margin-bottom:20px;">Jugar C√≥digo Diario (1/d√≠a)</button>
            </div>
            <div id="daily-optimal" style="display:none; margin-bottom:15px; background: rgba(0,0,0,0.2); padding:10px; border-radius:8px;">
                <div style="font-size: 12px; font-weight: bold; margin-bottom: 6px; color: var(--text-muted);">M√≠nimo te√≥rico: <span id="daily-optimal-count" style="color:white;">Calculando...</span></div>
                <button id="btn-daily-optimal" onclick="showNextOptimalStep()" class="solo-btn" style="display:none; font-size:12px; padding:8px;">Ver ruta √≥ptima</button>
                <div id="daily-optimal-path" style="display:none; margin-top:8px; font-size:12px; line-height:1.4;"></div>
                <button id="btn-next-hint" onclick="showNextOptimalStep()" class="solo-btn" style="display:none; background:#3b82f6; color:white; font-size:11px; margin-top:5px;">Siguiente Paso ‚Üí</button>
            </div>
            <div id="solo-stats">
                <div class="question-counter">TURNOS: <span id="q-counter">0</span> / 25</div>
                <div id="rank-table-container" style="display:none;">
                    <table class="rank-table" id="rank-table">
                        <tr><th>Rango</th><th>Turnos</th></tr>
                        <tr><td>Master Hacker</td><td id="range-master"></td></tr>
                        <tr><td colspan="2"><div class="bar-container"><div id="bar-master" class="bar-fill">0%</div></div></td></tr>
                        <tr><td>Cript√≥grafo</td><td id="range-crypto"></td></tr>
                        <tr><td colspan="2"><div class="bar-container"><div id="bar-crypto" class="bar-fill">0%</div></div></td></tr>
                        <tr><td>Analista</td><td id="range-analyst"></td></tr>
                        <tr><td colspan="2"><div class="bar-container"><div id="bar-analyst" class="bar-fill">0%</div></div></td></tr>
                        <tr><td>Aprendiz</td><td id="range-apprentice"></td></tr>
                        <tr><td colspan="2"><div class="bar-container"><div id="bar-apprentice" class="bar-fill">0%</div></div></td></tr>
                        <tr><td>Novato</td><td id="range-novice"></td></tr>
                        <tr><td colspan="2"><div class="bar-container"><div id="bar-novice" class="bar-fill">0%</div></div></td></tr>
                    </table>
                </div>
            </div>
        </div>

        <h3>INTERROGAR IA</h3>
        
        <div id="questions-block" style="pointer-events: none; opacity: 0.6;">
            <div class="q-box">
                <label>1. Suma de Segmentos</label>
                <div class="q-controls">
                    <select id="q1-v">
                        <optgroup label="Columnas"><option value="A">Columna A</option><option value="B">Columna B</option><option value="C">Columna C</option><option value="D">Columna D</option><option value="E">Columna E</option><option value="F">Columna F</option><option value="G">Columna G</option><option value="H">Columna H</option><option value="I">Columna I</option></optgroup>
                        <optgroup label="Filas"><option value="J">Fila J</option><option value="K">Fila K</option><option value="L">Fila L</option><option value="M">Fila M</option><option value="N">Fila N</option><option value="O">Fila O</option><option value="P">Fila P</option><option value="Q">Fila Q</option><option value="R">Fila R</option><option value="S">Fila S</option></optgroup>
                    </select>
                </div>
                <div style="display:flex; gap:6px; margin-top:8px;">
                    <button onclick="askQ1(false)" style="flex:1;">Preguntar</button>
                    <button class="btn-private" onclick="askQ1(true)" title="Pregunta privada" style="width:40px; flex-shrink:0;">
                        <svg viewBox="0 0 24 24" width="18" height="18" fill="white"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>
                    </button>
                </div>
            </div>
            <div class="q-box">
                <label>2. Par/Imp o 3. Comparar</label>
                <div class="q-controls">
                    <div style="display:flex; gap:5px; width: 100%;">
                        <select id="q2-1"><option value="0">T</option><option value="1">U</option><option value="2">V</option><option value="3">W</option><option value="4">X</option><option value="5">Y</option></select>
                        <select id="q2-2"><option value="">- Solo Par/Imp -</option><option value="0">T</option><option value="1">U</option><option value="2">V</option><option value="3">W</option><option value="4">X</option><option value="5">Y</option></select>
                    </div>
                </div>
                <div style="display:flex; gap:6px; margin-top:8px;">
                    <button onclick="askQ23(false)" style="flex:1;">Preguntar</button>
                    <button class="btn-private" onclick="askQ23(true)" title="Pregunta privada" style="width:40px; flex-shrink:0;">
                        <svg viewBox="0 0 24 24" width="18" height="18" fill="white"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>
                    </button>
                </div>
            </div>
            <div class="q-box">
                <label>4. Coordenada Exacta</label>
                <div class="q-controls">
                    <div style="display:flex; gap:5px; width: 100%;"><select id="q4-c"></select><select id="q4-r"></select></div>
                </div>
                <div style="display:flex; gap:6px; margin-top:8px;">
                    <button onclick="askQ4(false)" style="flex:1;">Preguntar</button>
                    <button class="btn-private" onclick="askQ4(true)" title="Pregunta privada" style="width:40px; flex-shrink:0;">
                        <svg viewBox="0 0 24 24" width="18" height="18" fill="white"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>
                    </button>
                </div>
            </div>
        </div>

        <div id="log"></div>
            
        <div id="resolve-block">
            <button id="btn-resolve" onclick="tryResolve()" style="background:var(--neon-red); color:white; margin-top:10px; font-size:14px; box-shadow:0 0 10px rgba(248, 113, 113, 0.4);">RESOLVER C√ìDIGO ‚ù§Ô∏è‚ù§Ô∏è</button>
            <button id="btn-reveal" onclick="reveal()" style="background:#334155; color:#fff; margin-top: 10px; display:none;">Ver Soluci√≥n (Solo Dealer)</button>
        </div>
    </div>
</div>

<script>
    const firebaseConfig = { apiKey: "AIzaSyDWST4NKU_roqoGsMAAevs4zd-c4IqAOEU", authDomain: "digitcode-d991e.firebaseapp.com", databaseURL: "https://digitcode-d991e-default-rtdb.europe-west1.firebasedatabase.app", projectId: "digitcode-d991e", storageBucket: "digitcode-d991e.firebasestorage.app", messagingSenderId: "958984288633", appId: "1:958984288633:web:c88980de5de0a5422597a8" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const shapes = {0:[1,1,1,1,1,1,0],1:[0,1,1,0,0,0,0],2:[1,1,0,1,1,0,1],3:[1,1,1,1,0,0,1],4:[0,1,1,0,0,1,1],5:[1,0,1,1,0,1,1],6:[1,0,1,1,1,1,1],7:[1,1,1,0,0,0,0],8:[1,1,1,1,1,1,1],9:[1,1,1,1,0,1,1]};
    const ady = {0:[1,3], 1:[0,2,4], 2:[1,5], 3:[0,4], 4:[1,3,5], 5:[2,4]};
    const names = ['T','U','V','W','X','Y'];
    const playerColors = ['#00e676', '#ffea00', '#ff1744', '#00d2ff', '#e040fb', '#ff9100', '#2979ff', '#1de9b6', '#c6ff00', '#ff5252'];
    
    let secret = null;
    let myName = "";
    let roomId = "";
    let gameMode = "multi"; 
    let soloType = ""; 
    let gameState = null;
    let soloQCount = 0;
    let soloAttempts = 0;
    let lastVictoryMsg = "";
    let localVictoryShown = false;
    let dailyOptimalData = null;
    let currentStepIndex = 0;
    let hintsUsedCount = 0;
    
    let undoStack = [];
    let redoStack = [];
    let usedQuestions = new Set();

    function captureState() {
        return {
            inputs: Array.from(document.querySelectorAll('#main-grid input')).map(i => i.value),
            segs: Array.from(document.querySelectorAll('.seg')).map(s => s.className),
            scratch: Array.from(document.querySelectorAll('.num-pick')).map(n => n.classList.contains('scratched')),
            parity: Array.from(document.querySelectorAll('.p-indicator')).map(p => p.classList.contains('active')),
            comps: Array.from(document.querySelectorAll('.comp')).map(c => ({ t: c.innerText, bg: c.style.background, cls: c.className }))
        };
    }

    function applyState(s) {
        const inputs = document.querySelectorAll('#main-grid input');
        const segs = document.querySelectorAll('.seg');
        const scratch = document.querySelectorAll('.num-pick');
        const parity = document.querySelectorAll('.p-indicator');
        const comps = document.querySelectorAll('.comp');
        
        inputs.forEach((el, i) => el.value = s.inputs[i]);
        segs.forEach((el, i) => el.className = s.segs[i]);
        scratch.forEach((el, i) => el.classList.toggle('scratched', s.scratch[i]));
        parity.forEach((el, i) => el.classList.toggle('active', s.parity[i]));
        comps.forEach((el, i) => {
            el.innerText = s.comps[i].t;
            el.style.background = s.comps[i].bg;
            el.className = s.comps[i].cls;
        });
    }

    function saveAction() {
        if(undoStack.length > 50) undoStack.shift();
        undoStack.push(captureState());
        redoStack = [];
        updateToolBtns();
    }

    window.execUndo = () => {
        if(undoStack.length === 0) return;
        redoStack.push(captureState());
        const prevState = undoStack.pop();
        applyState(prevState);
        updateToolBtns();
    };

    window.execRedo = () => {
        if(redoStack.length === 0) return;
        undoStack.push(captureState());
        const nextState = redoStack.pop();
        applyState(nextState);
        updateToolBtns();
    };

    window.execClear = () => {
        if(!confirm("¬øBorrar todas tus anotaciones?")) return;
        saveAction();
        resetBoard();
    };

    function updateToolBtns() {
        document.getElementById('btn-undo').disabled = undoStack.length === 0;
        document.getElementById('btn-redo').disabled = redoStack.length === 0;
    }

    function setQuestionsState(enabled) {
        const qBlock = document.getElementById('questions-block');
        qBlock.style.pointerEvents = enabled ? "auto" : "none";
        qBlock.style.opacity = enabled ? "1" : "0.6";
        if(gameMode === 'solo') {
            document.querySelectorAll('.btn-private').forEach(b => b.style.display = 'none');
        }
    }
    
    function connectMulti() {
        myName = document.getElementById('p-name').value.trim().toUpperCase();
        roomId = document.getElementById('p-room').value.trim().toUpperCase();
        if(!myName || !roomId) return alert("Faltan datos");
        gameMode = "multi"; gameState = null; 
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('solo-panel').style.display = 'none';
        document.getElementById('multi-setup').style.display = 'block';
        document.getElementById('panel-title').innerText = "CONFIGURACI√ìN";
        const roomRef = db.ref('rooms/' + roomId);
        roomRef.once('value', snapshot => {
            if(!snapshot.exists()) { roomRef.set({ turn: 0, players: [myName], logs: [{m: "PARTIDA INICIADA", s: "ok", p: "SISTEMA"}], dealer: "", privateUsed: {} }); }
            else { let p = snapshot.val().players || []; if(!p.includes(myName)) { p.push(myName); roomRef.update({ players: p }); } }
            roomRef.on('value', s => { gameState = s.val(); if(gameState) { secret = gameState.secret; syncUI(); checkMultiWinner(); autoFillFromLog(); } });
        });
    }

    function initSolitaireMenu() {
        myName = document.getElementById('p-name').value.trim().toUpperCase();
        if(!myName) return alert("Introduce tu nombre primero");
        gameMode = "solo";
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('multi-setup').style.display = 'none';
        document.getElementById('panel-title').innerText = "SOLITARIO: " + myName;
        document.getElementById('solo-panel').style.display = 'block';
        document.getElementById('solo-controls').style.display = 'block';
        setQuestionsState(false);
        loadSoloStats(); checkDailyStatus();
    }

    function autoFillFromLog() {
        if(!gameState || !gameState.logs) return;
        gameState.logs.forEach(log => {
            if (log.isPrivate && log.p !== myName) return; 
            applyLogToSheet(log.m);
        });
    }

    function applyLogToSheet(msg) {
        if(msg.startsWith("Suma en ")) {
            let label = msg.split(":")[0].replace("Suma en ", "").trim();
            let val = msg.split(":")[1].trim();
            let inputs = document.querySelectorAll('.label-row input, .abc-item input');
            inputs.forEach(inp => {
                if(inp.parentElement.innerText.trim().startsWith(label)) {
                    if(inp.value === "") { inp.value = val; inp.classList.add('auto-fill'); }
                }
            });
        }
        else if(msg.includes(" es ") && (msg.includes("PAR") || msg.includes("IMPAR"))) {
            let parts = msg.split(" es ");
            let dName = parts[0].trim();
            let type = parts[1].trim();
            let block = Array.from(document.querySelectorAll('.digit-block input')).find(i => i.placeholder === dName)?.parentElement;
            if(block) {
                let ind = block.querySelector(`.p-indicator[data-type="${type}"]`);
                if(ind && !ind.classList.contains('active')) { ind.classList.add('active', 'auto-fill'); }
            }
        }
        else if(msg.includes(" > ") || msg.includes(" < ") || msg.includes(" = ")) {
            let symbol = msg.includes(">") ? ">" : (msg.includes("<") ? "<" : "=");
            let parts = msg.split(symbol);
            let d1 = parts[0].trim(); let d2 = parts[1].trim();
            let idx1 = names.indexOf(d1); let idx2 = names.indexOf(d2);
            if(idx1 === -1 || idx2 === -1) return;
            
            let pMin = Math.min(idx1, idx2);
            let pMax = Math.max(idx1, idx2);
            let compKey = pMin + '-' + pMax;
            
            let domSymbol = symbol;
            if(idx1 > idx2) {
                if(symbol === '>') domSymbol = '<';
                else if(symbol === '<') domSymbol = '>';
            }

            let compEl = document.querySelector(`.comp[data-pair="${compKey}"]`);
            if(compEl && compEl.innerText === "?") {
                compEl.innerText = domSymbol;
                // Ajuste de estilo para el modo ne√≥n
                compEl.style.color = "#fbbf24"; 
                compEl.style.borderColor = "#fbbf24";
                compEl.classList.add('auto-fill');
                if(compEl.parentElement.classList.contains('v-comps')) compEl.classList.add('rotate-90');
            }
        }
        else if(msg.includes(": ENCENDIDO") || msg.includes(": APAGADO")) {
            let parts = msg.split(": ");
            let coord = parts[0];
            let state = parts[1];
            let c = coord.split("-")[0]; let r = coord.split("-")[1];
            const cIdx = ['ABC','DEF','GHI'].findIndex(g => g.includes(c)); 
            const dIdx = cIdx + ('OPQRS'.includes(r) ? 3 : 0);
            const map = {"1-0":"s-a","2-1":"s-b","2-3":"s-c","1-4":"s-d","0-3":"s-e","0-1":"s-f","1-2":"s-g"};
            const cT = ['ADG','BEH','CFI'].findIndex(g => g.includes(c)); 
            const rT = ['JO','KP','LQ','MR','NS'].findIndex(g => g.includes(r));
            const sClass = map[`${cT}-${rT}`];
            let digitBlocks = document.querySelectorAll('.digit-block');
            let targetSeg = digitBlocks[dIdx].querySelector('.' + sClass);
            if(targetSeg) {
                if(state === "ENCENDIDO" && !targetSeg.classList.contains('st-1')) {
                    targetSeg.classList.add('st-1', 'auto-fill');
                } else if(state === "APAGADO" && !targetSeg.classList.contains('st-off-auto')) {
                    targetSeg.classList.add('st-off-auto', 'auto-fill');
                }
            }
        }
    }

    function checkDailyStatus() {
        const dateStr = new Date().toLocaleDateString('es-ES', { timeZone: 'Europe/Madrid' }).replace(/\//g, '');
        db.ref(`users/${myName}/daily/${dateStr}`).once('value', s => {
            const btn = document.getElementById('btn-solo-daily');
            if(s.exists()) { btn.classList.add('btn-disabled'); btn.innerHTML = "C√≥digo Diario (JUGADO)"; btn.onclick = null; }
            else { btn.classList.remove('btn-disabled'); btn.innerHTML = "Jugar C√≥digo Diario (1/d√≠a)"; btn.onclick = () => startSolitaire('daily'); }
        });
    }

    function getRankRanges() {
        if(soloType === 'daily' && dailyOptimalData) {
            const o = dailyOptimalData.steps.length;
            return {
                master:     { min: 1,       max: o,       label: `1 - ${o}` },
                crypto:     { min: o+1,     max: o+4,     label: `${o+1} - ${o+4}` },
                analyst:    { min: o+5,     max: o+8,     label: `${o+5} - ${o+8}` },
                apprentice: { min: o+9,     max: o+12,    label: `${o+9} - ${o+12}` },
                novice:     { min: o+13,    max: Infinity, label: `+${o+12}` }
            };
        }
        return {
            master:     { min: 1,  max: 9,        label: '1 - 9' },
            crypto:     { min: 10, max: 14,       label: '10 - 14' },
            analyst:    { min: 15, max: 19,       label: '15 - 19' },
            apprentice: { min: 20, max: 25,       label: '20 - 25' },
            novice:     { min: 26, max: Infinity, label: '+25' }
        };
    }

    function getRankKey(count) {
        const r = getRankRanges();
        if(count <= r.master.max)     return 'master';
        if(count <= r.crypto.max)     return 'crypto';
        if(count <= r.analyst.max)    return 'analyst';
        if(count <= r.apprentice.max) return 'apprentice';
        return 'novice';
    }

    function getRankLabel(key) {
        return { master: 'Master Hacker üéñÔ∏è', crypto: 'Cript√≥grafo üïµÔ∏è', analyst: 'Analista üìä', apprentice: 'Aprendiz üìö', novice: 'Novato üå±' }[key];
    }

    function showRankTable() {
        const r = getRankRanges();
        document.getElementById('range-master').innerText     = r.master.label;
        document.getElementById('range-crypto').innerText     = r.crypto.label;
        document.getElementById('range-analyst').innerText    = r.analyst.label;
        document.getElementById('range-apprentice').innerText = r.apprentice.label;
        document.getElementById('range-novice').innerText     = r.novice.label;
        document.getElementById('rank-table-container').style.display = 'block';
        loadSoloStats();
    }

    function loadSoloStats() {
        db.ref('users/' + myName + '/stats').once('value', s => {
            let stats = s.val() || {}; let total = stats.total || 0;
            const updateBar = (id, val) => {
                let pct = total > 0 ? Math.round((val/total)*100) : 0;
                let el = document.getElementById(id); el.style.width = pct + "%"; el.innerText = pct + "%";
            };
            if(total >= 0) { updateBar('bar-master', stats.master || 0); updateBar('bar-crypto', stats.crypto || 0); updateBar('bar-analyst', stats.analyst || 0); updateBar('bar-apprentice', stats.apprentice || 0); updateBar('bar-novice', stats.novice || 0); }
        });
    }

    function resetBoard() {
        document.querySelectorAll('.seg').forEach(s => s.classList.remove('st-1', 'st-off-auto', 'auto-fill'));
        document.querySelectorAll('.num-pick').forEach(n => n.classList.remove('scratched'));
        document.querySelectorAll('#main-grid input').forEach(i => { 
            i.value = ""; i.classList.remove('auto-fill');
        });
        document.querySelectorAll('.comp').forEach(c => { 
            c.innerText = "?"; c.style.background = "#1e293b"; c.style.color = "#94a3b8"; c.style.borderColor = "#475569"; c.classList.remove('rotate-90', 'auto-fill'); 
        });
        document.querySelectorAll('.p-indicator').forEach(p => p.classList.remove('active', 'auto-fill'));
    }

    function startSolitaire(type) {
        if(type === 'daily') { if(document.getElementById('btn-solo-daily').classList.contains('btn-disabled')) return; }
        soloType = type; soloQCount = 0; soloAttempts = 0; hintsUsedCount = 0;
        usedQuestions = new Set();
        document.getElementById('rank-table-container').style.display = 'none';
        document.getElementById('q-counter').innerText = "0";
        const cw = document.getElementById('q-counter').closest('.question-counter');
        if(cw) { cw.classList.remove('turn-warn','turn-danger'); cw.classList.add('turn-safe'); }
        document.getElementById('log').innerHTML = "";
        resetBoard();
        undoStack = []; redoStack = []; updateToolBtns(); 
        document.getElementById('solo-controls').style.display = 'none';
        document.getElementById('daily-optimal').style.display = type === 'daily' ? 'block' : 'none';
        document.getElementById('daily-optimal-count').innerText = "Calculando...";
        document.getElementById('daily-optimal-path').style.display = 'none';
        document.getElementById('daily-optimal-path').innerText = "";
        document.getElementById('btn-daily-optimal').style.display = 'none';
        document.getElementById('btn-next-hint').style.display = 'none';
        document.getElementById('btn-next-hint').disabled = false;
        document.getElementById('btn-next-hint').style.opacity = "1";
        document.getElementById('btn-next-hint').innerText = "Siguiente Paso ‚Üí";
        dailyOptimalData = null;
        currentStepIndex = 0;
        if(type === 'daily') {
            const dateStr = new Date().toLocaleDateString('es-ES', { timeZone: 'Europe/Madrid' }).replace(/\//g, '');
            secret = generateDailyCode(dateStr); activateSoloGame();
            setTimeout(() => { computeDailyOptimalPlan(); }, 50);
        } else { secret = generateRandomCode(); activateSoloGame(); }
    }

    function activateSoloGame() {
        setQuestionsState(true);
        document.getElementById('btn-resolve').innerHTML = "RESOLVER C√ìDIGO ‚ù§Ô∏è‚ù§Ô∏è";
        document.getElementById('btn-resolve').disabled = false;
        document.getElementById('btn-resolve').style.background = "#f87171";
        logSolo("Partida iniciada. Modo: " + (soloType==='daily'?'DIARIO':'ALEATORIO'), "var(--neon-green)", true);
    }

    function logSolo(msg, color="var(--neon-green)", isSystem=false) {
        const lBox = document.getElementById('log');
        const turnNum = isSystem ? 0 : soloQCount;
        let html = `<div><span style="color:var(--neon-orange); font-weight:bold; margin-right:6px;">[${turnNum}]</span>${msg}</div>`;
        lBox.innerHTML = html + lBox.innerHTML;
        applyLogToSheet(msg);
    }

    function generateRandomCode() {
        let temp = [null,null,null,null,null,null];
        for(let i=0; i<6; i++) {
            let forbid = []; ady[i].forEach(n => { if(temp[n]!==null) forbid.push(temp[n]); });
            let poss = [0,1,2,3,4,5,6,7,8,9].filter(x => !forbid.includes(x));
            temp[i] = poss[Math.floor(Math.random()*poss.length)];
        }
        return temp;
    }

    function generateDailyCode(seedStr) {
        let seed = parseInt(seedStr);
        const random = function() { var t = seed += 0x6D2B79F5; t = Math.imul(t ^ t >>> 15, t | 1); t ^= t + Math.imul(t ^ t >>> 7, t | 61); return ((t ^ t >>> 14) >>> 0) / 4294967296; };
        let temp = [null,null,null,null,null,null];
        for(let i=0; i<6; i++) {
            let forbid = []; ady[i].forEach(n => { if(temp[n]!==null) forbid.push(temp[n]); });
            let poss = [0,1,2,3,4,5,6,7,8,9].filter(x => !forbid.includes(x));
            temp[i] = poss[Math.floor(random()*poss.length)];
        }
        return temp;
    }

    function getAllValidCodes() {
        let codes = [];
        let temp = [null,null,null,null,null,null];
        const digits = [0,1,2,3,4,5,6,7,8,9];
        const fill = (idx) => {
            if(idx === 6) { codes.push(temp.slice()); return; }
            for(const d of digits) {
                let ok = true;
                for(const n of ady[idx]) {
                    if(n < idx && temp[n] === d) { ok = false; break; }
                }
                if(!ok) continue;
                temp[idx] = d;
                fill(idx + 1);
                temp[idx] = null;
            }
        };
        fill(0);
        return codes;
    }

    function getQ4Coords() {
        const coords = [];
        const cols = 'ABCDEFGHI'.split('');
        const rows = 'JKLMNOPQRS'.split('');
        const map = {"1-0":0,"2-1":1,"2-3":2,"1-4":3,"0-3":4,"0-1":5,"1-2":6};
        cols.forEach(c => rows.forEach(r => {
            const cT = ['ADG','BEH','CFI'].findIndex(g => g.includes(c));
            const rT = ['JO','KP','LQ','MR','NS'].findIndex(g => g.includes(r));
            const sIdx = map[`${cT}-${rT}`];
            if(sIdx !== undefined) coords.push({ c, r });
        }));
        return coords;
    }

    function getDailyQuestions() {
        const questions = [];
        'ABCDEFGHI'.split('').forEach(v => questions.push({ type: 'q1', v }));
        'JKLMNOPQRS'.split('').forEach(v => questions.push({ type: 'q1', v }));
        names.forEach((_, idx) => questions.push({ type: 'parity', idx }));
        const pairs = [[0,1],[0,3],[1,2],[1,4],[2,5],[3,4],[4,5]];
        pairs.forEach(pair => questions.push({ type: 'compare', pair }));
        getQ4Coords().forEach(coord => questions.push({ type: 'q4', coord }));
        return questions;
    }

    function answerFor(code, question) {
        if(question.type === 'q1') {
            const v = question.v;
            const colMap = {'A':[0,3,[5,4]],'B':[0,3,[0,6,3]],'C':[0,3,[1,2]],'D':[1,4,[5,4]],'E':[1,4,[0,6,3]],'F':[1,4,[1,2]],'G':[2,5,[5,4]],'H':[2,5,[0,6,3]],'I':[2,5,[1,2]]};
            const rowMap = {'J':[[0,1,2],[0]],'K':[[0,1,2],[5,1]],'L':[[0,1,2],[6]],'M':[[0,1,2],[4,2]],'N':[[0,1,2],[3]],'O':[[3,4,5],[0]],'P':[[3,4,5],[5,1]],'Q':[[3,4,5],[6]],'R':[[3,4,5],[4,2]],'S':[[3,4,5],[3]]};
            let c = 0;
            if(colMap[v]) colMap[v].slice(0,2).forEach(d=>colMap[v][2].forEach(s=>{if(shapes[code[d]][s])c++;}));
            else rowMap[v][0].forEach(d=>rowMap[v][1].forEach(s=>{if(shapes[code[d]][s])c++;}));
            return c.toString();
        }
        if(question.type === 'parity') {
            return code[question.idx] % 2 === 0 ? 'PAR' : 'IMPAR';
        }
        if(question.type === 'compare') {
            const [d1, d2] = question.pair;
            if(code[d1] > code[d2]) return '>';
            if(code[d1] < code[d2]) return '<';
            return '=';
        }
        if(question.type === 'q4') {
            const c = question.coord.c;
            const r = question.coord.r;
            const cIdx = ['ABC','DEF','GHI'].findIndex(g => g.includes(c));
            const dIdx = cIdx + ('OPQRS'.includes(r) ? 3 : 0);
            const map = {"1-0":0,"2-1":1,"2-3":2,"1-4":3,"0-3":4,"0-1":5,"1-2":6};
            const cT = ['ADG','BEH','CFI'].findIndex(g => g.includes(c));
            const rT = ['JO','KP','LQ','MR','NS'].findIndex(g => g.includes(r));
            const sIdx = map[`${cT}-${rT}`];
            return shapes[code[dIdx]][sIdx] ? 'ENCENDIDO' : 'APAGADO';
        }
        return '';
    }

    function questionLabel(question) {
        if(question.type === 'q1') return `Q1 ${question.v}`;
        if(question.type === 'parity') return `Q2 ${names[question.idx]} PAR/IMP`;
        if(question.type === 'compare') return `Q3 ${names[question.pair[0]]} vs ${names[question.pair[1]]}`;
        if(question.type === 'q4') return `Q4 ${question.coord.c}-${question.coord.r}`;
        return '';
    }

    function computeDailyOptimalPlan() {
        if(soloType !== 'daily' || !secret) return;
        const candidates = getAllValidCodes();
        const secretStr = secret.join('');
        const questions = getDailyQuestions();
        const secretAnswers = questions.map(q => answerFor(secret, q));

        const iddfs = (candidateIdxs, depth, path) => {
            if(candidateIdxs.length === 1) return true;
            if(depth === 0) return false;
            const minBound = Math.ceil(Math.log2(candidateIdxs.length));
            if(minBound > depth) return false;
            const ranked = [];
            for(let q = 0; q < questions.length; q++) {
                const next = [];
                const answer = secretAnswers[q];
                for(const idx of candidateIdxs) {
                    if(answerFor(candidates[idx], questions[q]) === answer) next.push(idx);
                }
                if(next.length < candidateIdxs.length) ranked.push({ q, next });
            }
            ranked.sort((a, b) => a.next.length - b.next.length);
            for(const option of ranked) {
                path.push(option.q);
                if(iddfs(option.next, depth - 1, path)) return true;
                path.pop();
            }
            return false;
        };

        const initial = candidates.map((_, idx) => idx);
        let depth = 0;
        let plan = [];
        while(true) {
            plan = [];
            if(iddfs(initial, depth, plan)) break;
            depth++;
        }

        dailyOptimalData = {
            secret: secretStr,
            steps: plan.map(qIdx => ({
                label: questionLabel(questions[qIdx]),
                answer: secretAnswers[qIdx]
            }))
        };

        document.getElementById('daily-optimal-count').innerText = `${dailyOptimalData.steps.length} preguntas`;
        document.getElementById('btn-daily-optimal').style.display = 'block';
    }

    function showNextOptimalStep() {
        if(!dailyOptimalData) return;
        const pathBox = document.getElementById('daily-optimal-path');
        const nextBtn = document.getElementById('btn-next-hint');
        const startBtn = document.getElementById('btn-daily-optimal');
        
        if (currentStepIndex < dailyOptimalData.steps.length) {
            startBtn.style.display = 'none';
            pathBox.style.display = 'block';
            nextBtn.style.display = 'block';
            
            const step = dailyOptimalData.steps[currentStepIndex];
            const stepHtml = `<div class="hint-step"><strong>Paso ${currentStepIndex + 1}:</strong> ${step.label} ‚Üí <span style="color:var(--neon-blue)">${step.answer}</span></div>`;
            pathBox.innerHTML += stepHtml;
            
            currentStepIndex++;
            hintsUsedCount++; 
            
            if (currentStepIndex >= dailyOptimalData.steps.length) {
                nextBtn.innerText = "¬°Ruta completada!";
                nextBtn.disabled = true;
                nextBtn.style.opacity = "0.5";
            }
        }
    }

    function syncUI() {
        if(gameMode !== 'multi') return;
        if(!gameState || !gameState.players) return;
        const curIdx = gameState.turn % gameState.players.length;
        const curPlayer = gameState.players[curIdx];
        const isMyTurn = curPlayer === myName;
        const banner = document.getElementById('turn-display');
        banner.innerText = isMyTurn ? "¬°TU TURNO!" : "TURNO: " + curPlayer;
        banner.className = "turn-tag " + (isMyTurn ? "active" : "");
        setQuestionsState(isMyTurn);
        const hasUsedPrivate = gameState.privateUsed && gameState.privateUsed[myName];
        document.querySelectorAll('.btn-private').forEach(b => b.style.display = (isMyTurn && !hasUsedPrivate) ? 'flex' : 'none');
        
        let pListHtml = "";
        gameState.players.forEach((p, i) => {
            let color = playerColors[i % playerColors.length];
            let isCurrent = (curPlayer === p);
            let marker = isCurrent ? "‚ñ∂ " : "&nbsp;&nbsp;";
            pListHtml += `<div class="pl-row" style="color:${color}; font-weight:${isCurrent?900:400}"><span>${marker}${p}</span></div>`;
        });
        document.getElementById('player-list-box').innerHTML = pListHtml;
        if(secret) document.getElementById('setup-area').style.display = 'none';
        else document.getElementById('setup-area').style.display = 'block'; 
        document.getElementById('btn-reveal').style.display = (gameState.dealer === myName) ? 'block' : 'none';
        const attempts = (gameState.attempts && gameState.attempts[myName]) || 0;
        const lastFail = (gameState.lastFailTurn && gameState.lastFailTurn[myName]) || -1;
        const btnResolve = document.getElementById('btn-resolve');
        let hearts = attempts === 0 ? "‚ù§Ô∏è‚ù§Ô∏è" : (attempts === 1 ? "‚ù§Ô∏èüñ§" : "üñ§üñ§");
        let onCooldown = (attempts === 1 && gameState.turn < lastFail + gameState.players.length);
        if(attempts >= 2) { btnResolve.innerHTML = `ELIMINADO ${hearts}`; btnResolve.disabled = true; btnResolve.style.background = "#334155"; }
        else if (onCooldown) { btnResolve.innerHTML = `ESPERANDO TURNO... ${hearts}`; btnResolve.disabled = true; btnResolve.style.background = "#fbbf24"; }
        else { btnResolve.innerHTML = `RESOLVER C√ìDIGO ${hearts}`; btnResolve.disabled = false; btnResolve.style.background = "#f87171"; }
        const lBox = document.getElementById('log');
        lBox.innerHTML = (gameState.logs || []).slice().reverse().map((l, i) => {
            let color = l.p === "SISTEMA" ? "var(--neon-green)" : (playerColors[gameState.players.indexOf(l.p) % playerColors.length] || "#fff");
            let message = l.m; if (l.isPrivate && l.p !== myName) { message = "üïµÔ∏è RESPUESTA PRIVADA"; color = "var(--neon-purple)"; }
            return `<div style="border-left-color:${color}"><strong>${l.p}:</strong> ${message}</div>`;
        }).join('');
    }

    function checkMultiWinner() {
        if(gameMode !== 'multi' || localVictoryShown) return;
        const winnerLog = (gameState.logs || []).find(l => l.m.includes("¬°GANADOR:"));
        if(winnerLog) {
            localVictoryShown = true;
            const participants = (gameState.players || []).join(', ');
            lastVictoryMsg = `¬°FINAL DE PARTIDA! üèÜ ${winnerLog.m} en la Sala: ${roomId}. Participantes: ${participants}. üß†‚ú® <a href="https://bit.ly/MŒªryS0l" target="_blank" style="color:var(--neon-green);text-decoration:none;">https://bit.ly/MŒªryS0l</a>`;
            document.getElementById('win-title').innerText = "¬°PARTIDA FINALIZADA!";
            document.getElementById('win-text').innerHTML = lastVictoryMsg;
            document.getElementById('win-modal').style.display = 'flex';
        }
    }

    function checkSoloLimit() {
        if(gameMode === 'solo') {
            soloQCount++; 
            const qCounterEl = document.getElementById('q-counter');
            qCounterEl.innerText = soloQCount;
            const counterWrap = qCounterEl.closest('.question-counter');
            if(counterWrap) {
                counterWrap.classList.remove('turn-safe','turn-warn','turn-danger');
                counterWrap.classList.add(soloQCount < 10 ? 'turn-safe' : soloQCount < 20 ? 'turn-warn' : 'turn-danger');
            }
            if(soloQCount > 25) {
                alert("¬°L√çMITE CR√çTICO ALCANZADO! Has perdido.");
                setQuestionsState(false);
                document.getElementById('btn-resolve').disabled = true;
                logSolo("DERROTA POR TIEMPO", "#ff1744", true); saveSoloResult('loss'); showRankTable(); return false;
            }
        }
        return true;
    }

    window.tryResolve = () => {
        const guess = prompt("INTRODUCE EL C√ìDIGO DE 6 D√çGITOS:");
        if(!guess) return;
        if(gameMode === 'solo') {
            if(guess === secret.join('')) {
                let rankKey = getRankKey(soloQCount);
                let rankLabel = getRankLabel(rankKey);
                const today = new Date().toLocaleDateString('es-ES');
                const tipoStr = (soloType === 'daily') ? `diario del d√≠a ${today}` : `aleatorio`;
                let dailyInfo = "";
                let hintsBadge = "";
                if(soloType === 'daily') {
                    if(dailyOptimalData) {
                        dailyInfo = `\n\nüéØ M√≠nimo te√≥rico: ${dailyOptimalData.steps.length} turnos.`;
                    }
                    const hintsColor = hintsUsedCount === 0 ? 'var(--neon-green)' : hintsUsedCount <= 2 ? 'var(--neon-orange)' : 'var(--neon-red)';
                    hintsBadge = `<div style="margin-top:10px; display:inline-block; background:rgba(0,0,0,0.3); border:1px solid ${hintsColor}; border-radius:6px; padding:4px 12px; font-size:12px; color:${hintsColor}; font-family:'Orbitron',sans-serif; letter-spacing:1px;">üí° PISTAS USADAS: ${hintsUsedCount}</div>`;
                }
                lastVictoryMsg = `¬°VICTORIA! üèÜ Has logrado descifrar el c√≥digo secreto ${tipoStr} en ${soloQCount} turnos. Rango alcanzado: ${rankLabel}.${dailyInfo} üß†‚ú® <a href="https://bit.ly/MŒªryS0l" target="_blank" style="color:var(--neon-green);text-decoration:none;">https://bit.ly/MŒªryS0l</a>${hintsBadge}`;
                logSolo(`¬°VICTORIA! El c√≥digo es ${secret.join('')}`, "#4caf50", true);
                document.getElementById('win-title').innerText = "üéâ ¬°VICTORIA! üéâ";
                document.getElementById('win-text').innerHTML = lastVictoryMsg;
                document.getElementById('daily-ranking').style.display = 'none';
                document.getElementById('win-modal').style.display = 'flex';
                saveSoloResult(rankKey);
                if(soloType === 'daily') saveDailyScore(rankKey, rankLabel);
                showRankTable();
                setQuestionsState(false);
                document.getElementById('btn-resolve').disabled = true;
            } else {
                soloAttempts++;
                if(soloAttempts >= 2) { 
                    logSolo(`ELIMINADO. El c√≥digo era ${secret.join('')}`, "#ff1744", true);
                    alert("ELIMINADO. C√≥digo: " + secret.join('')); saveSoloResult('loss');
                    showRankTable();
                    setQuestionsState(false);
                    document.getElementById('btn-resolve').disabled = true; 
                } else { alert("C√≥digo incorrecto. 1 vida."); document.getElementById('btn-resolve').innerHTML = "RESOLVER C√ìDIGO ‚ù§Ô∏èüñ§"; }
            }
            return;
        }
        const attempts = (gameState.attempts && gameState.attempts[myName]) || 0;
        const newAttempts = {...(gameState.attempts || {})}; newAttempts[myName] = attempts + 1;
        const newFailTurn = {...(gameState.lastFailTurn || {})};
        if(guess === secret.join('')) {
            let newLogs = gameState.logs || []; newLogs.push({ m: `¬°GANADOR: ${myName}! C√≥digo: ${secret.join('')}`, p: myName, s: 'ok' });
            db.ref('rooms/' + roomId).update({ logs: newLogs, turn: gameState.turn + 1 });
        } else {
            newFailTurn[myName] = gameState.turn;
            let newLogs = gameState.logs || []; newLogs.push({ m: `FALL√ì EL C√ìDIGO`, p: myName, s: 'error' });
            db.ref('rooms/' + roomId).update({ attempts: newAttempts, lastFailTurn: newFailTurn, logs: newLogs, turn: gameState.turn + 1 });
        }
    };

    function copyToClipboard() {
        const tempDiv = document.createElement("div");
        tempDiv.innerHTML = lastVictoryMsg;
        let txt = tempDiv.textContent || tempDiv.innerText;
        if(soloType === 'daily') {
            const today = new Date().toLocaleDateString('es-ES', { timeZone: 'Europe/Madrid' });
            const rankLabel = getRankLabel(getRankKey(soloQCount));
            const badge = document.getElementById('my-position-badge').innerText;
            const rankRows = Array.from(document.querySelectorAll('.rank-list-row')).map(row => {
                const pos    = row.querySelector('.pos').innerText;
                const name   = row.querySelector('.rname').innerText.replace(' ‚óÄ T√ö','').trim();
                const turns  = row.querySelector('.rturns').innerText;
                const rrank  = row.querySelector('.rrank').innerText;
                const isMe   = row.classList.contains('me');
                return `${pos} ${name}${isMe ? ' ‚óÄ' : ''} ¬∑ ${turns} ¬∑ ${rrank}`;
            }).join('\n');
            const total = document.getElementById('rank-total').innerText;
            txt = `HIDE CODE ‚Äî C√≥digo Diario ${today}\nüèÜ ${soloQCount} turnos ¬∑ ${rankLabel} ¬∑ üí° ${hintsUsedCount} pista${hintsUsedCount !== 1 ? "s" : ""}\n\nüìä CLASIFICACI√ìN DEL D√çA\n${badge}\n${rankRows}\n${total}\n\nhttps://bit.ly/MŒªryS0l`;
        }
        navigator.clipboard.writeText(txt).then(() => {
            alert("¬°Resultado copiado al portapapeles!");
        });
    }

    function saveSoloResult(rank) {
        const userRef = db.ref('users/' + myName);
        userRef.child('stats').transaction(current => {
            current = current || { total: 0, master: 0, crypto: 0, analyst: 0, apprentice: 0, novice: 0, loss: 0 };
            current.total++; if(current[rank] !== undefined) current[rank]++; return current;
        }, (err, committed, s) => { if(committed) { loadSoloStats(); checkDailyStatus(); } });
        if(soloType === 'daily') { const dateStr = new Date().toLocaleDateString('es-ES', { timeZone: 'Europe/Madrid' }).replace(/\//g, ''); userRef.child('daily/' + dateStr).set(true); }
        document.getElementById('solo-controls').style.display = 'block';
    }


    function saveDailyScore(rankKey, rankLabel) {
        if(soloType !== 'daily') return;
        const dateStr = new Date().toLocaleDateString('es-ES', { timeZone: 'Europe/Madrid' }).replace(/\//g, '');
        const safeKey = myName.replace(/[.#$\[\]]/g, '_');
        db.ref('daily_scores/' + dateStr + '/' + safeKey).set({
            name: myName,
            turns: soloQCount,
            rank: rankLabel,
            rankKey: rankKey,
            ts: Date.now()
        }, () => { loadDailyRanking(dateStr); });
    }

    function loadDailyRanking(dateStr) {
        db.ref('daily_scores/' + dateStr).once('value', snap => {
            if(!snap.exists()) return;
            const data = snap.val();
            const entries = Object.values(data)
                .filter(e => e.turns && e.name)
                .sort((a, b) => a.turns - b.turns || a.ts - b.ts);

            const myPos = entries.findIndex(e => e.name === myName) + 1;
            const total = entries.length;
            const top5 = entries.slice(0, 5);
            const meInTop5 = top5.some(e => e.name === myName);
            const displayEntries = meInTop5 ? top5 : [...top5.slice(0,4), entries[myPos-1]];

            const posMedals = ['ü•á','ü•à','ü•â'];
            const posClasses = ['gold','silver','bronze'];

            let rowsHtml = '';
            displayEntries.forEach((e, i) => {
                const realPos = entries.indexOf(e) + 1;
                const isMe = e.name === myName;
                const medal = realPos <= 3 ? posMedals[realPos-1] : '#' + realPos;
                const posClass = realPos <= 3 ? posClasses[realPos-1] : '';
                rowsHtml += `<div class="rank-list-row ${isMe ? 'me' : ''}">
                    <div class="pos ${posClass}">${medal}</div>
                    <div class="rname ${isMe ? 'me' : ''}">${e.name}${isMe ? ' ‚óÄ T√ö' : ''}</div>
                    <div class="rturns">${e.turns} turnos</div>
                    <div class="rrank">${e.rank}</div>
                </div>`;
            });

            document.getElementById('my-position-badge').innerText = `Tu posici√≥n: #${myPos} de ${total} jugadores hoy`;
            document.getElementById('rank-list').innerHTML = rowsHtml;
            document.getElementById('rank-total').innerText = `${total} jugador${total !== 1 ? 'es' : ''} han completado el c√≥digo hoy`;
            document.getElementById('daily-ranking').style.display = 'block';
        });
    }

    window.askQ1 = (isPrivate) => {
        const v = document.getElementById('q1-v').value;
        const qKey = `Q1-${v}`;
        if(gameMode === 'solo' && usedQuestions.has(qKey)) {
            logSolo(`‚ö†Ô∏è Ya preguntaste por la ${v.length === 1 && v >= 'A' && v <= 'I' ? 'columna' : 'fila'} ${v}`, "#ff1744", true);
            return;
        }
        if(!checkSoloLimit()) return;
        if(gameMode === 'solo') usedQuestions.add(qKey);
        const colMap = {'A':[0,3,[5,4]],'B':[0,3,[0,6,3]],'C':[0,3,[1,2]],'D':[1,4,[5,4]],'E':[1,4,[0,6,3]],'F':[1,4,[1,2]],'G':[2,5,[5,4]],'H':[2,5,[0,6,3]],'I':[2,5,[1,2]]};
        const rowMap = {'J':[[0,1,2],[0]],'K':[[0,1,2],[5,1]],'L':[[0,1,2],[6]],'M':[[0,1,2],[4,2]],'N':[[0,1,2],[3]],'O':[[3,4,5],[0]],'P':[[3,4,5],[5,1]],'Q':[[3,4,5],[6]],'R':[[3,4,5],[4,2]],'S':[[3,4,5],[3]]};
        let c = 0; if(colMap[v]) colMap[v].slice(0,2).forEach(d=>colMap[v][2].forEach(s=>{if(shapes[secret[d]][s])c++}));
        else rowMap[v][0].forEach(d=>rowMap[v][1].forEach(s=>{if(shapes[secret[d]][s])c++}));
        let msg = `Suma en ${v}: ${c}`; if(gameMode === 'solo') logSolo(msg); else sendMultiLog(msg, isPrivate);
    };

    window.askQ23 = (isPrivate) => {
        const d1 = parseInt(document.getElementById('q2-1').value); const d2v = document.getElementById('q2-2').value;
        const qKey = d2v === "" ? `Q2-${d1}` : `Q3-${Math.min(d1,parseInt(d2v))}-${Math.max(d1,parseInt(d2v))}`;
        let msg = ""; let isErr = false;
        if(d2v === "") {
            if(gameMode === 'solo' && usedQuestions.has(qKey)) { logSolo(`‚ö†Ô∏è Ya preguntaste por la paridad de ${names[d1]}`, "#ff1744", true); return; }
            msg = `${names[d1]} es ${secret[d1]%2===0?'PAR':'IMPAR'}`;
        } else {
            const d2 = parseInt(d2v);
            if(!ady[d1].includes(d2)) { msg = "Error: No adyacentes"; isErr = true; }
            else {
                if(gameMode === 'solo' && usedQuestions.has(qKey)) { logSolo(`‚ö†Ô∏è Ya comparaste ${names[d1]} y ${names[d2]}`, "#ff1744", true); return; }
                let res = secret[d1] > secret[d2] ? '>' : (secret[d1] < secret[d2] ? '<' : '='); msg = `${names[d1]} ${res} ${names[d2]}`;
            }
        }
        if(isErr) { logSolo(msg, '#ff1744', true); return; }
        if(!checkSoloLimit()) return;
        if(gameMode === 'solo') usedQuestions.add(qKey);
        if(gameMode === 'solo') logSolo(msg, '#00e676'); else sendMultiLog(msg, isPrivate, isErr);
    };

    window.askQ4 = (isPrivate) => {
        const c = document.getElementById('q4-c').value; const r = document.getElementById('q4-r').value;
        const cIdx = ['ABC','DEF','GHI'].findIndex(g => g.includes(c)); const dIdx = cIdx + ('OPQRS'.includes(r) ? 3 : 0);
        const map = {"1-0":0,"2-1":1,"2-3":2,"1-4":3,"0-3":4,"0-1":5,"1-2":6};
        const cT = ['ADG','BEH','CFI'].findIndex(g => g.includes(c)); const rT = ['JO','KP','LQ','MR','NS'].findIndex(g => g.includes(r));
        const sIdx = map[`${cT}-${rT}`];
        if(sIdx === undefined) { logSolo(`‚ö†Ô∏è Coordenada ${c}-${r} no v√°lida`, "#ff1744", true); return; }
        const qKey = `Q4-${c}-${r}`;
        if(gameMode === 'solo' && usedQuestions.has(qKey)) { logSolo(`‚ö†Ô∏è Ya preguntaste por la coordenada ${c}-${r}`, "#ff1744", true); return; }
        if(!checkSoloLimit()) return;
        if(gameMode === 'solo') usedQuestions.add(qKey);
        let msg = `${c}-${r}: ${shapes[secret[dIdx]][sIdx]?'ENCENDIDO':'APAGADO'}`;
        if(gameMode === 'solo') logSolo(msg); else sendMultiLog(msg, isPrivate);
    };

    function sendMultiLog(msg, isPrivate, isErr = false) {
        let l = gameState.logs || []; l.push({ m: msg, p: myName, s: isErr?'error':'ok', isPrivate: isPrivate });
        let updates = { logs: l, turn: gameState.turn + 1 };
        if (isPrivate) { let used = gameState.privateUsed || {}; used[myName] = true; updates.privateUsed = used; }
        db.ref('rooms/' + roomId).update(updates);
    }

    window.setManualCode = () => {
        let temp = []; for(let i=0; i<6; i++) { let v=document.getElementById('s-'+i).value; if(v===""||isNaN(v))return alert("Error"); temp.push(parseInt(v)); }
        for(let i=0; i<6; i++) { for(let n of ady[i]) { if(temp[i] === temp[n]) return alert("Adyacentes iguales"); } }
        localVictoryShown = false;
        db.ref('rooms/'+roomId).update({secret:temp, dealer:myName, logs:[{m:"C√ìDIGO MANUAL", s:"ok", p:"SISTEMA"}], attempts: {}, lastFailTurn: {}});
    };
    window.setRandomCode = () => { 
        localVictoryShown = false;
        db.ref('rooms/'+roomId).update({secret:generateRandomCode(), dealer:myName, logs:[{m:"ALEATORIO GENERADO", s:"ok", p:"SISTEMA"}], attempts: {}, lastFailTurn: {}}); 
    };
    window.reveal = () => { if(gameMode === 'multi' && gameState.dealer === myName) { let l = gameState.logs || []; l.push({m:`SOLUCI√ìN: ${secret.join('-')}`, p:myName, s:'ok'}); db.ref('rooms/'+roomId).update({logs:l}); } };
    
    // WRAPPERS FOR ACTIONS TO HANDLE UNDO
    window.m = (el) => { 
        saveAction(); 
        if(el.classList.contains('st-1')) el.classList.remove('st-1'); 
        else if(el.classList.contains('st-off-auto')) el.classList.remove('st-off-auto'); 
        else el.classList.add('st-1'); 
    };
    window.cyc = (el) => { 
        saveAction();
        const s = ['?', '>', '<']; let next = (s.indexOf(el.innerText)+1)%3; el.innerText = s[next]; 
        // En el modo dark, el fondo amarillo brillante no se ve bien, usamos una versi√≥n m√°s oscura
        el.style.background = s[next] === '?' ? '#1e293b' : '#475569'; 
        el.style.color = s[next] === '?' ? '#94a3b8' : '#fbbf24'; 
        el.style.borderColor = s[next] === '?' ? '#475569' : '#fbbf24';
        if(el.parentElement.classList.contains('v-comps')) { if(s[next]!=='?') el.classList.add('rotate-90'); else el.classList.remove('rotate-90'); } 
    };
    window.toggleScratch = (el) => { saveAction(); el.classList.toggle('scratched'); };
    window.toggleParity = (el) => { saveAction(); el.classList.toggle('active'); };

    (function(){
        const bar = document.getElementById('ref-bar');
        for(let i=0; i<=9; i++) {
            let res = shapes[i]; bar.innerHTML += `<div class="ref-item"><div class="ref-num">${i}</div><div class="mini-seg-grid"><div class="ms m-h ${res[0]?'active-ref':''}" style="top:0"></div><div class="ms m-v ${res[5]?'active-ref':''}" style="top:2px;left:0"></div><div class="ms m-v ${res[1]?'active-ref':''}" style="top:2px;right:0"></div><div class="ms m-h ${res[6]?'active-ref':''}" style="top:16px"></div><div class="ms m-v ${res[4]?'active-ref':''}" style="top:18px;left:0"></div><div class="ms m-v ${res[2]?'active-ref':''}" style="top:18px;right:0"></div><div class="ms m-h ${res[3]?'active-ref':''}" style="bottom:0"></div></div></div>`;
        }
        const grid = document.getElementById('main-grid');
        let html = '<div class="labels-side">'; 'JKLMN'.split('').forEach(l => html += `<div class="label-row">${l}<input onchange="saveAction()"></div>`); html += '</div>';
        [0,1,2].forEach(i => {
            const pairKey = i < 2 ? `${i}-${i+1}` : null;
            html += `<div class="digit-block"><div class="abc-header">${[['A','B','C'],['D','E','F'],['G','H','I']][i].map(l=>`<div class="abc-item">${l}<input onchange="saveAction()"></div>`).join('')}</div><div class="digit-visual">${['s-a','s-b','s-c','s-d','s-e','s-f','s-g'].map(s=>`<div class="seg ${s=='s-a'||s=='s-g'||s=='s-d'?'seg-h':'seg-v'} ${s}" onclick="m(this)"></div>`).join('')}</div><div class="scratch-pad">${[0,2,4,6,8].map(n=>`<div class="num-pick" onclick="toggleScratch(this)">${n}</div>`).join('')}${[1,3,5,7,9].map(n=>`<div class="num-pick" onclick="toggleScratch(this)">${n}</div>`).join('')}</div><div class="parity-container"><div class="p-indicator" data-type="PAR" onclick="toggleParity(this)">P</div><div class="p-indicator" data-type="IMPAR" onclick="toggleParity(this)">I</div></div><input style="margin-top:5px; width:50px; text-align:center; font-weight:bold" placeholder="${names[i]}" onchange="saveAction()"></div>`;
            if(i < 2) html += `<div class="comp" data-pair="${pairKey}" onclick="cyc(this)">?</div>`;
        });
        html += `<div class="v-comps">
            <div class="comp" data-pair="0-3" onclick="cyc(this)">?</div>
            <div class="comp" data-pair="1-4" onclick="cyc(this)">?</div>
            <div class="comp" data-pair="2-5" onclick="cyc(this)">?</div>
        </div>`;
        html += '<div class="labels-side">'; 'OPQRS'.split('').forEach(l => html += `<div class="label-row">${l}<input onchange="saveAction()"></div>`); html += '</div>';
        [3,4,5].forEach(i => {
            const pairKey = i < 5 ? `${i}-${i+1}` : null;
            html += `<div class="digit-block bottom-row"><div class="digit-visual">${['s-a','s-b','s-c','s-d','s-e','s-f','s-g'].map(s=>`<div class="seg ${s=='s-a'||s=='s-g'||s=='s-d'?'seg-h':'seg-v'} ${s}" onclick="m(this)"></div>`).join('')}</div><div class="scratch-pad">${[0,2,4,6,8].map(n=>`<div class="num-pick" onclick="toggleScratch(this)">${n}</div>`).join('')}${[1,3,5,7,9].map(n=>`<div class="num-pick" onclick="toggleScratch(this)">${n}</div>`).join('')}</div><div class="parity-container"><div class="p-indicator" data-type="PAR" onclick="toggleParity(this)">P</div><div class="p-indicator" data-type="IMPAR" onclick="toggleParity(this)">I</div></div><input style="margin-top:5px; width:50px; text-align:center; font-weight:bold" placeholder="${names[i]}" onchange="saveAction()"></div>`;
            if(i < 5) html += `<div class="comp" data-pair="${pairKey}" onclick="cyc(this)">?</div>`;
        });
        grid.innerHTML = html;
        document.getElementById('q4-c').innerHTML = 'ABCDEFGHI'.split('').map(v => `<option value="${v}">${v}</option>`).join('');
        document.getElementById('q4-r').innerHTML = 'JKLMNOPQRS'.split('').map(v => `<option value="${v}">${v}</option>`).join('');
    })();

    // --- TUTORIAL ---
    let tutCurrent = 0;
    const TUT_TOTAL = 7;

    function openTutorial() {
        tutCurrent = 0;
        const modal = document.getElementById('tutorial-modal');
        modal.style.display = 'flex';
        // build dots
        const dotsEl = document.getElementById('tut-dots');
        dotsEl.innerHTML = '';
        for(let i = 0; i < TUT_TOTAL; i++) {
            const d = document.createElement('div');
            d.className = 'tut-dot' + (i === 0 ? ' active' : '');
            d.onclick = () => tutGoTo(i);
            dotsEl.appendChild(d);
        }
        tutGoTo(0);
    }

    function tutGoTo(idx) {
        document.getElementById('tslide-' + tutCurrent).style.display = 'none';
        tutCurrent = idx;
        const slide = document.getElementById('tslide-' + tutCurrent);
        slide.style.display = 'flex';
        slide.style.animation = 'none';
        slide.offsetHeight; // reflow
        slide.style.animation = '';
        document.getElementById('tut-cur').innerText = tutCurrent + 1;
        document.getElementById('tut-progress').style.width = ((tutCurrent + 1) / TUT_TOTAL * 100) + '%';
        document.querySelectorAll('.tut-dot').forEach((d, i) => d.classList.toggle('active', i === tutCurrent));
        document.getElementById('tut-prev').disabled = tutCurrent === 0;
        const nextBtn = document.getElementById('tut-next');
        if(tutCurrent === TUT_TOTAL - 1) {
            nextBtn.innerText = '¬°EMPEZAR! üöÄ';
            nextBtn.onclick = closeTutorial;
        } else {
            nextBtn.innerText = 'SIGUIENTE ‚Üí';
            nextBtn.onclick = () => tutChange(1);
        }
    }

    function tutChange(dir) {
        const next = tutCurrent + dir;
        if(next < 0 || next >= TUT_TOTAL) return;
        tutGoTo(next);
    }

    function closeTutorial() {
        document.getElementById('tutorial-modal').style.display = 'none';
    }

    document.addEventListener('keydown', e => {
        if(document.getElementById('tutorial-modal').style.display === 'flex') {
            if(e.key === 'ArrowRight') tutChange(1);
            if(e.key === 'ArrowLeft')  tutChange(-1);
            if(e.key === 'Escape')     closeTutorial();
        }
    });
</script>
</body>
</html>